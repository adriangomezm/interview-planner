<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Interview Builder — Talkpush</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700;800;900&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
@font-face {
  font-family: 'Polymath Text';
  src: url('fonts/PolymathTextDemo-Medium.otf') format('opentype');
  font-weight: 400;
  font-style: normal;
  font-display: swap;
}
@font-face {
  font-family: 'Polymath Text';
  src: url('fonts/PolymathTextDemo-Medium.otf') format('opentype');
  font-weight: 500;
  font-style: normal;
  font-display: swap;
}
@font-face {
  font-family: 'Polymath Text';
  src: url('fonts/PolymathTextDemo-Bold.otf') format('opentype');
  font-weight: 600;
  font-style: normal;
  font-display: swap;
}
@font-face {
  font-family: 'Polymath Text';
  src: url('fonts/PolymathTextDemo-Bold.otf') format('opentype');
  font-weight: 700;
  font-style: normal;
  font-display: swap;
}
@font-face {
  font-family: 'Polymath Text';
  src: url('fonts/PolymathTextDemo-Bold.otf') format('opentype');
  font-weight: 800;
  font-style: normal;
  font-display: swap;
}
@font-face {
  font-family: 'Polymath Text';
  src: url('fonts/PolymathTextDemo-Bold.otf') format('opentype');
  font-weight: 900;
  font-style: normal;
  font-display: swap;
}
:root {
  --primary: #111115;
  --primary-hover: rgba(17,17,21,0.85);
  --accent: #F1C1F3;
  --accent-light: rgba(241,193,243,0.15);
  --accent-mid: rgba(241,193,243,0.25);
  --blue: #B8D4C8;
  --blue-dark: #8FBAAa;
  --blue-light: #EFF6F3;
  --blue-mid: rgba(184,212,200,0.12);
  --teal: #C5CAE9;
  --teal-light: #ECEEF7;
  --teal-dark: #7A82B3;
  --orange: #F0A830;
  --orange-light: #FDF5E6;
  --green: #B8D4C8;
  --green-light: #EFF6F3;
  --bg: #FFFFF5;
  --surface: #FFFFFF;
  --surface2: #FFFFF5;
  --border: #E8E4DF;
  --border-strong: #D4CFC9;
  --text: #1A1A1A;
  --text-mid: #4A4A4A;
  --muted: #8A8A8A;
  --radius: 6px;
  --radius-lg: 10px;
  --shadow: none;
  --shadow-hover: none;
  --shadow-card: none;
  --pink: #F1C1F3;
  --pink-light: rgba(241,193,243,0.12);
  --lavender: #C5CAE9;
}
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
html { scroll-behavior: smooth; }
body {
  background: var(--bg);
  color: var(--text);
  font-family: 'Polymath Text', 'DM Sans', -apple-system, sans-serif;
  min-height: 100vh;
  font-size: 14px;
  line-height: 1.5;
}

/* ── LAYOUT ── */
.shell { display: flex; min-height: 100vh; }

/* ── SIDEBAR ── */
.sidebar {
  width: 256px; min-width: 256px;
  background: #1A1A1D;
  border-right: 1px solid rgba(255,255,255,0.08);
  display: flex; flex-direction: column;
  position: fixed; top: 0; left: 0; bottom: 0;
  z-index: 100; overflow: hidden;
}
.sidebar-head {
  padding: 22px 20px 18px;
  border-bottom: 1px solid rgba(255,255,255,0.08);
  flex-shrink: 0;
}
.tp-logo {
  display: flex; align-items: center; gap: 0;
  margin-bottom: 14px;
}
.tp-logo img {
  height: 24px;
  display: block;
}
.tp-logo-txt {
  font-family: 'Space Grotesk', sans-serif;
  font-size: 18px; font-weight: 800; letter-spacing: -0.5px; color: #FFFFFF;
  line-height: 1;
}
.tp-logo-txt span { color: var(--accent); }
.live-pill {
  display: inline-flex; align-items: center; gap: 7px;
  background: var(--accent-light); border: 1px solid var(--accent-mid);
  border-radius: 100px; padding: 5px 12px;
  font-size: 11px; font-weight: 700; letter-spacing: 0.4px;
  text-transform: uppercase; color: var(--accent);
}
.live-dot {
  width: 6px; height: 6px; border-radius: 50%; background: var(--accent);
  animation: livepulse 2s infinite;
  flex-shrink: 0;
}
@keyframes livepulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:0.4;transform:scale(0.65)} }

.sidebar-nav { flex: 1; padding: 16px 10px; overflow-y: auto; }
.nav-item {
  display: flex; align-items: center; gap: 11px;
  padding: 9px 12px; border-radius: 9px;
  cursor: pointer; transition: all 0.18s; margin-bottom: 1px;
  border: 1px solid transparent;
}
.nav-item:hover:not(.locked) { background: rgba(255,255,255,0.06); }
.nav-item.active { background: var(--accent-light); border-color: var(--accent-mid); }
.nav-item.locked { opacity: 0.35; cursor: not-allowed; }
.nav-circle {
  width: 26px; height: 26px; min-width: 26px; border-radius: 50%;
  border: 1.5px solid rgba(255,255,255,0.2);
  display: flex; align-items: center; justify-content: center;
  font-size: 11px; font-weight: 700; color: rgba(255,255,255,0.5);
  transition: all 0.18s; flex-shrink: 0;
}
.nav-item.active .nav-circle { background: var(--accent); border-color: var(--accent); color: var(--primary); }
.nav-item.done .nav-circle { background: var(--teal); border-color: var(--teal); color: #fff; font-size: 13px; }
.nav-label { font-size: 12.5px; font-weight: 500; color: rgba(255,255,255,0.55); transition: color 0.18s; }
.nav-item.active .nav-label { color: var(--accent); font-weight: 600; }
.nav-item.done .nav-label { color: rgba(255,255,255,0.85); }

.sidebar-foot {
  padding: 14px 20px; border-top: 1px solid rgba(255,255,255,0.08); flex-shrink: 0;
}
.lang-row { display: flex; gap: 6px; align-items: center; }
.lang-label { font-size: 11px; font-weight: 600; color: rgba(255,255,255,0.45); text-transform: uppercase; letter-spacing: 0.4px; margin-right: 4px; }
.lang-toggle { display: flex; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.12); border-radius: 7px; overflow: hidden; }
.lang-btn {
  padding: 5px 14px; font-size: 12px; font-weight: 600;
  font-family: 'Polymath Text', 'DM Sans', sans-serif; cursor: pointer;
  border: none; background: transparent; color: rgba(255,255,255,0.45); transition: all 0.18s;
}
.lang-btn.active { background: var(--primary); color: #FFFFF5; }

/* ── MAIN ── */
.main { margin-left: 256px; flex: 1; min-height: 100vh; }
.main-inner { padding: 40px 48px 80px; max-width: 860px; }

/* Steps */
.step { display: none; }
.step.on { display: block; animation: stepIn 0.3s ease; }
@keyframes stepIn { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }

/* Page header */
.phead { margin-bottom: 30px; }
.step-pill {
  display: inline-flex; align-items: center; gap: 5px;
  font-size: 11px; font-weight: 700; letter-spacing: 0.5px; text-transform: uppercase;
  color: var(--text-mid); background: var(--pink-light); border-radius: 100px;
  padding: 4px 12px; margin-bottom: 12px;
}
.ptitle { font-family: 'Space Grotesk', sans-serif; font-size: 24px; font-weight: 800; letter-spacing: -0.4px; color: var(--text); margin-bottom: 6px; line-height: 1.25; }
.ptitle em { font-style: normal; color: var(--accent); }
.pdesc { font-size: 13.5px; color: var(--muted); line-height: 1.6; max-width: 500px; }

/* ── CARDS ── */
.cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(185px,1fr)); gap: 9px; margin-bottom: 28px; }
.card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 16px 14px;
  cursor: pointer; transition: all 0.18s; position: relative;
  box-shadow: var(--shadow-card);
}
.card:hover { border-color: var(--accent); }
.card.sel { border-color: var(--accent); background: var(--pink-light); }
.card.sel::after {
  content: '✓'; position: absolute; top: 9px; right: 10px;
  background: var(--primary); color: #FFFFF5; width: 19px; height: 19px;
  border-radius: 50%; display: flex; align-items: center; justify-content: center;
  font-size: 10px; font-weight: 800;
}
.card-ico { font-size: 22px; margin-bottom: 9px; }
.card-title { font-weight: 700; font-size: 12.5px; color: var(--text); margin-bottom: 3px; }
.card-desc { font-size: 11px; color: var(--muted); line-height: 1.5; }

/* ── SKILLS ── */
.skills-panel {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--radius-lg); padding: 18px 22px;
  margin-bottom: 18px; display: flex; gap: 24px; flex-wrap: wrap;
  box-shadow: var(--shadow-card);
}
.sp-count-col { flex-shrink: 0; }
.sp-label { font-size: 10.5px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--muted); margin-bottom: 6px; }
.sp-big { font-size: 48px; font-weight: 900; color: var(--primary); line-height: 1; letter-spacing: -3px; margin-bottom: 3px; }
.sp-sub { font-size: 11px; color: var(--muted); }
.sp-tiers-col { flex: 1; min-width: 250px; }
.tiers { display: flex; flex-direction: column; gap: 5px; }
.tier-row {
  display: flex; align-items: center; gap: 10px;
  padding: 8px 12px; border-radius: 8px;
  border: 1px solid var(--border); background: var(--surface2);
  transition: all 0.2s;
}
.tier-row.active { border-color: var(--accent); background: var(--pink-light); }
.tier-badge { font-size: 11.5px; font-weight: 700; color: var(--text); min-width: 68px; }
.tier-detail { font-size: 11.5px; color: var(--muted); }
.tier-detail b { color: var(--text); font-weight: 600; }

.skills-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px,1fr)); gap: 7px; margin-bottom: 22px; }
.skill-chip {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 11px 13px;
  cursor: pointer; transition: all 0.18s;
  display: flex; align-items: flex-start; gap: 9px;
  box-shadow: var(--shadow-card);
}
.skill-chip:hover { border-color: var(--accent); }
.skill-chip.sel { border-color: var(--accent); background: var(--pink-light); }
.skill-checkbox {
  width: 17px; height: 17px; min-width: 17px;
  border: 2px solid var(--border-strong); border-radius: 4px;
  display: flex; align-items: center; justify-content: center;
  margin-top: 1px; transition: all 0.18s;
}
.skill-chip.sel .skill-checkbox { background: var(--primary); border-color: var(--primary); }
.skill-check-mark { display: none; color: #fff; font-size: 9px; font-weight: 800; }
.skill-chip.sel .skill-check-mark { display: block; }
.sk-name { font-size: 12px; font-weight: 600; color: var(--text); margin-bottom: 2px; }
.sk-desc { font-size: 10.5px; color: var(--muted); line-height: 1.4; }

/* ── QUESTION SELECTION (step 3) ── */
.q-select-panel {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--radius-lg); padding: 18px 22px; margin-bottom: 18px;
  box-shadow: var(--shadow-card);
}
.q-select-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; flex-wrap: wrap; gap: 10px; }
.q-select-title { font-size: 14px; font-weight: 700; color: var(--text); }
.q-count-badge {
  display: inline-flex; align-items: center; gap: 6px;
  background: var(--teal-light); border: 1px solid rgba(0,201,192,0.25);
  border-radius: 100px; padding: 4px 12px;
  font-size: 11px; font-weight: 700; color: var(--teal-dark);
}
.q-loading {
  display: flex; flex-direction: column; align-items: center; gap: 12px;
  padding: 36px 20px; color: var(--muted);
}
.q-mini-spinner {
  width: 28px; height: 28px; border: 2px solid var(--blue-light);
  border-top-color: var(--accent); border-radius: 50%;
  animation: spin 0.7s linear infinite;
}
.q-loading-text { font-size: 13px; }
.q-list { display: flex; flex-direction: column; gap: 7px; }
.q-item {
  display: flex; align-items: flex-start; gap: 12px;
  padding: 12px 14px; border-radius: var(--radius);
  border: 1px solid var(--border); background: var(--surface2);
  cursor: pointer; transition: all 0.18s;
}
.q-item:hover { border-color: var(--accent); background: var(--surface); }
.q-item.sel { border-color: var(--accent); background: var(--pink-light); }
.q-item.disabled { opacity: 0.38; cursor: not-allowed; pointer-events: none; }
.q-num {
  width: 26px; height: 26px; min-width: 26px; border-radius: 50%;
  background: var(--pink-light); color: var(--text-mid);
  font-size: 11px; font-weight: 800; display: flex; align-items: center; justify-content: center;
  flex-shrink: 0; margin-top: 1px; transition: all 0.18s;
}
.q-item.sel .q-num { background: var(--primary); color: #FFFFF5; }
.q-text { font-size: 12.5px; color: var(--text); line-height: 1.5; }
.q-skill-tag {
  margin-top: 4px; display: inline-block;
  font-size: 10px; font-weight: 700; color: var(--teal-dark);
  background: var(--teal-light); border-radius: 4px; padding: 1px 7px;
}

.numq-hint {
  font-size: 12.5px; color: var(--text-mid);
  padding: 10px 14px; background: var(--teal-light);
  border: 1px solid rgba(0,201,192,0.25); border-radius: 8px;
  margin-bottom: 14px; line-height: 1.55;
}
.numq-hint b { color: var(--primary); }

.q-select-footer {
  display: flex; align-items: center; justify-content: space-between;
  margin-top: 14px; padding-top: 12px; border-top: 1px solid var(--border);
  flex-wrap: wrap; gap: 8px;
}
.q-sel-count { font-size: 12.5px; color: var(--muted); font-weight: 500; }
.q-sel-count b { color: var(--primary); font-weight: 700; }

/* ── PERSONA ── */
.persona-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(192px,1fr)); gap: 9px; margin-bottom: 28px; }
.persona-card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 16px; cursor: pointer;
  transition: all 0.18s; position: relative; box-shadow: var(--shadow-card);
}
.persona-card:hover { border-color: var(--accent); }
.persona-card.sel { border-color: var(--accent); background: var(--pink-light); }
.persona-card.sel::after {
  content: '✓'; position: absolute; top: 9px; right: 10px;
  background: var(--primary); color: #FFFFF5; width: 19px; height: 19px;
  border-radius: 50%; display: flex; align-items: center; justify-content: center;
  font-size: 10px; font-weight: 800;
}
.persona-ava {
  width: 40px; height: 40px; border-radius: 50%; margin-bottom: 9px;
  display: flex; align-items: center; justify-content: center; font-size: 18px;
}
.persona-name { font-weight: 700; font-size: 13.5px; color: var(--text); margin-bottom: 2px; }
.persona-tone { font-size: 11px; font-weight: 600; margin-bottom: 5px; }
.persona-traits { font-size: 10.5px; color: var(--muted); line-height: 1.5; }

/* ── SUMMARY ── */
.sum-card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--radius-lg); padding: 20px 22px; margin-bottom: 22px;
  box-shadow: var(--shadow-card);
}
.sum-heading { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--muted); margin-bottom: 12px; }
.sum-tags { display: flex; flex-wrap: wrap; gap: 7px; }
.sum-tag {
  padding: 5px 12px; border-radius: 100px; font-size: 12px; font-weight: 500;
  background: var(--blue-light); border: 1px solid rgba(184,212,200,0.4); color: var(--text);
}
.sum-tag.teal { background: var(--teal-light); border-color: rgba(197,202,233,0.4); color: var(--teal-dark); }
.sum-tag.orange { background: var(--orange-light); border-color: rgba(240,168,48,0.3); color: #B07A10; }
.sum-tag.pink { background: var(--pink-light); border-color: rgba(240,184,208,0.4); color: #B05A80; }

/* ── BUTTONS ── */
.btn-primary {
  display: inline-flex; align-items: center; gap: 7px;
  background: var(--primary); border: none; border-radius: var(--radius);
  padding: 11px 22px; color: #FFFFF5; font-family: 'Polymath Text', 'DM Sans', sans-serif;
  font-size: 13.5px; font-weight: 700; cursor: pointer; transition: all 0.18s;
}
.btn-primary:hover { background: var(--primary-hover); }
.btn-primary:disabled { opacity: 0.38; cursor: not-allowed; }
.btn-ghost {
  display: inline-flex; align-items: center; gap: 7px;
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 11px 22px; color: var(--text-mid);
  font-family: 'Polymath Text', 'DM Sans', sans-serif; font-size: 13.5px; font-weight: 700;
  cursor: pointer; transition: all 0.18s;
}
.btn-ghost:hover { border-color: var(--primary); color: var(--primary); }
.step-nav { display: flex; justify-content: space-between; align-items: center; padding-top: 8px; }

.btn-gen {
  width: 100%; display: flex; align-items: center; justify-content: center; gap: 9px;
  background: var(--primary); border: none; border-radius: var(--radius);
  padding: 15px 28px; color: #FFFFF5; font-family: 'Polymath Text', 'DM Sans', sans-serif;
  font-size: 14.5px; font-weight: 700; cursor: pointer; transition: all 0.22s;
}
.btn-gen:hover { background: var(--primary-hover); }
.btn-gen:disabled { opacity: 0.38; cursor: not-allowed; }
.btn-spin { width: 17px; height: 17px; border: 2px solid rgba(255,255,255,0.35); border-top-color: #fff; border-radius: 50%; animation: spin 0.7s linear infinite; display: none; }
.btn-gen.loading .btn-spin { display: block; }
@keyframes spin { to{transform:rotate(360deg)} }

/* ── OUTPUT ── */
.out-bar { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
.out-done {
  display: inline-flex; align-items: center; gap: 7px;
  background: var(--green-light); border: 1px solid rgba(184,212,200,0.5);
  border-radius: 100px; padding: 7px 16px; font-size: 13px; font-weight: 600; color: #3D7A5E;
}
.restart-btn {
  padding: 7px 16px; background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--radius); font-size: 12.5px; font-weight: 500; color: var(--text-mid);
  cursor: pointer; transition: all 0.18s; font-family: 'Polymath Text', 'DM Sans', sans-serif;
}
.restart-btn:hover { border-color: var(--primary); color: var(--primary); }

.out-blocks { display: flex; flex-direction: column; gap: 10px; }
.out-block {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow-card);
  transition: border-color 0.18s;
}
.out-block:hover { border-color: var(--accent); }
.out-block-head {
  display: flex; align-items: center; justify-content: space-between;
  padding: 11px 16px; background: var(--surface2);
  border-bottom: 1px solid var(--border); cursor: pointer;
}
.out-block-title { display: flex; align-items: center; gap: 8px; font-weight: 700; font-size: 12.5px; color: var(--text); }
.type-tag {
  font-size: 10px; font-weight: 700; letter-spacing: 0.3px; text-transform: uppercase;
  padding: 2px 8px; border-radius: 4px;
}
.type-blue { background: var(--pink-light); color: #9B5A9D; }
.type-teal { background: var(--teal-light); color: var(--teal-dark); }
.type-orange { background: var(--orange-light); color: var(--orange); }
.type-green { background: var(--green-light); color: #3D7A5E; }
.out-actions { display: flex; align-items: center; gap: 7px; }
.cp-btn {
  display: flex; align-items: center; gap: 4px; padding: 4px 11px;
  background: #fff; border: 1px solid var(--border); border-radius: 6px;
  color: var(--muted); font-size: 11px; font-weight: 600; cursor: pointer;
  transition: all 0.18s; font-family: 'Polymath Text', 'DM Sans', sans-serif;
}
.cp-btn:hover { border-color: var(--primary); color: var(--primary); }
.cp-btn.ok { border-color: var(--teal); color: var(--teal-dark); }
.col-btn {
  width: 22px; height: 22px; border-radius: 5px; border: 1px solid var(--border);
  background: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center;
  font-size: 12px; color: var(--muted); transition: all 0.18s;
}
.col-btn:hover { border-color: var(--primary); color: var(--primary); }
.out-content {
  padding: 16px 18px; font-size: 12.5px; line-height: 1.75; color: var(--text-mid);
  white-space: pre-wrap; word-break: break-word;
  max-height: 420px; overflow-y: auto; font-family: 'Polymath Text', 'DM Sans', sans-serif;
}
.out-content.collapsed { display: none; }
.out-content::-webkit-scrollbar { width: 4px; }
.out-content::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

.copy-all {
  width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px;
  padding: 12px 24px; background: #fff; border: 1px solid var(--teal);
  border-radius: var(--radius); color: var(--teal-dark); font-family: 'Polymath Text', 'DM Sans', sans-serif;
  font-weight: 700; font-size: 13px; cursor: pointer; transition: all 0.18s; margin-top: 10px;
}
.copy-all:hover { background: var(--teal-light); }

/* ── TEST INTERVIEW ── */
.test-section {
  margin-top: 24px; padding-top: 24px;
  border-top: 1px solid var(--border);
}
.test-header {
  display: flex; align-items: center; gap: 10px; margin-bottom: 6px;
}
.test-title {
  font-size: 14.5px; font-weight: 700; color: var(--text);
  font-family: 'Space Grotesk', sans-serif;
}
.test-desc {
  font-size: 12px; color: var(--muted); margin-bottom: 18px; line-height: 1.5;
}
.test-name-row {
  display: flex; align-items: center; gap: 10px; margin-bottom: 14px;
}
.test-name-label {
  font-size: 12.5px; font-weight: 600; color: var(--text); white-space: nowrap;
}
.test-name-input {
  flex: 1; padding: 8px 12px; border: 1px solid var(--border); border-radius: var(--radius);
  font-size: 13px; font-family: 'Polymath Text', 'DM Sans', sans-serif;
  color: var(--text); background: var(--surface); transition: border-color 0.2s;
}
.test-name-input:focus { outline: none; border-color: var(--accent); }
.test-call-btn {
  width: 100%; display: flex; align-items: center; justify-content: center; gap: 10px;
  padding: 14px 28px; background: var(--primary); border: none; border-radius: var(--radius);
  color: #FFFFF5; font-family: 'Polymath Text', 'DM Sans', sans-serif;
  font-size: 14px; font-weight: 700; cursor: pointer; transition: all 0.22s;
}
.test-call-btn:hover { background: var(--primary-hover); }
.test-call-btn:disabled { opacity: 0.4; cursor: not-allowed; }

/* ── CALL OVERLAY (ElevenLabs-style fullscreen) ── */
.call-overlay {
  display: none; position: fixed; inset: 0; z-index: 9999;
  flex-direction: column;
  background: linear-gradient(160deg, #F0B8D0 0%, #C5CAE9 40%, #B8D4C8 70%, #a8c8e8 100%);
  animation: fadeIn 0.3s ease;
}
.call-overlay.on { display: flex; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

/* ── Top bar ── */
.call-topbar {
  display: flex; align-items: center; justify-content: space-between;
  padding: 18px 28px; flex-shrink: 0;
}
.call-topbar-left {
  display: flex; align-items: center; gap: 10px;
  font-family: 'Space Grotesk', sans-serif;
  font-size: 14px; font-weight: 600; color: rgba(255,255,255,0.92);
}
.call-topbar-sep { opacity: 0.45; }
.call-topbar-timer { font-variant-numeric: tabular-nums; letter-spacing: 0.5px; }
.call-topbar-right {
  display: flex; align-items: center; gap: 6px;
}
.call-signal-bar {
  width: 3px; border-radius: 1.5px; background: rgba(255,255,255,0.7);
}
.call-signal-bar:nth-child(1) { height: 6px; }
.call-signal-bar:nth-child(2) { height: 10px; }
.call-signal-bar:nth-child(3) { height: 14px; }
.call-signal-bar:nth-child(4) { height: 18px; }

/* ── Center card ── */
.call-center {
  flex: 1; display: flex; align-items: center; justify-content: center;
  padding: 0 28px;
}
.call-card {
  width: 420px; max-width: 94vw;
  background: rgba(255,255,255,0.92); backdrop-filter: blur(20px);
  border-radius: 28px; padding: 40px 36px 32px;
  display: flex; flex-direction: column; align-items: center; gap: 4px;
  animation: cardUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
}
@keyframes cardUp {
  from { opacity: 0; transform: translateY(24px) scale(0.97); }
  to   { opacity: 1; transform: translateY(0) scale(1); }
}

/* Agent label inside card */
.call-agent-label {
  font-size: 15px; font-weight: 600; color: var(--muted);
  font-family: 'Polymath Text', 'DM Sans', sans-serif;
  letter-spacing: 0.3px; margin-bottom: 8px;
}

/* ── Glowing Orb ── */
.call-orb-wrap {
  position: relative; width: 130px; height: 130px;
  margin: 8px 0 16px; display: flex; align-items: center; justify-content: center;
}
.call-orb {
  width: 100px; height: 100px; border-radius: 50%;
  background: radial-gradient(circle at 38% 35%, #e0f5ee 0%, #B8D4C8 30%, #7ab8a0 65%, #4a9e80 100%);
  box-shadow: 0 0 40px rgba(184,212,200,0.5), 0 0 80px rgba(184,212,200,0.25), inset 0 -8px 20px rgba(0,0,0,0.08);
  transition: transform 0.4s ease, box-shadow 0.4s ease;
}
/* Glow ring behind orb */
.call-orb-wrap::before {
  content: ''; position: absolute; width: 130px; height: 130px;
  border-radius: 50%; opacity: 0;
  background: radial-gradient(circle, rgba(184,212,200,0.35) 0%, transparent 70%);
  transition: opacity 0.4s;
}
/* Pulsing outer ring */
.call-orb-wrap::after {
  content: ''; position: absolute; width: 130px; height: 130px;
  border-radius: 50%; border: 2px solid rgba(184,212,200,0.25);
  opacity: 0; transition: opacity 0.3s;
}

/* Orb states */
.call-overlay.connecting .call-orb {
  animation: orbPulseConnect 1.6s ease-in-out infinite;
}
.call-overlay.speaking .call-orb {
  transform: scale(1.08);
  box-shadow: 0 0 50px rgba(184,212,200,0.6), 0 0 100px rgba(184,212,200,0.35), inset 0 -8px 20px rgba(0,0,0,0.08);
}
.call-overlay.speaking .call-orb-wrap::before { opacity: 1; }
.call-overlay.speaking .call-orb-wrap::after { opacity: 1; animation: orbRingPulse 1.5s ease-out infinite; }
.call-overlay.listening .call-orb {
  animation: orbBreath 3s ease-in-out infinite;
}
.call-overlay.listening .call-orb-wrap::before { opacity: 0.5; }

@keyframes orbPulseConnect {
  0%, 100% { transform: scale(1); opacity: 0.7; }
  50% { transform: scale(1.04); opacity: 1; }
}
@keyframes orbBreath {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.03); }
}
@keyframes orbRingPulse {
  0% { transform: scale(1); opacity: 0.5; }
  100% { transform: scale(1.3); opacity: 0; }
}

/* Status badge */
.call-status-badge {
  display: inline-flex; align-items: center; gap: 7px;
  padding: 5px 16px; border-radius: 20px;
  font-size: 12px; font-weight: 600;
  background: rgba(184,212,200,0.18); color: #5a8a74;
  transition: all 0.25s; margin-bottom: 16px;
}
.call-overlay.connecting .call-status-badge { background: rgba(240,168,48,0.12); color: #c08520; }
.call-overlay.speaking .call-status-badge  { background: rgba(197,202,233,0.22); color: #5c64a0; }
.call-overlay.listening .call-status-badge { background: rgba(184,212,200,0.18); color: #5a8a74; }

.call-status-dot {
  width: 7px; height: 7px; border-radius: 50%;
  background: currentColor; transition: background 0.2s;
}
.call-overlay.connecting .call-status-dot { animation: dotPulse 1s ease-in-out infinite; }
.call-overlay.speaking .call-status-dot   { animation: dotPulse 0.8s ease-in-out infinite; }
@keyframes dotPulse { 0%,100%{opacity:1} 50%{opacity:0.3} }

/* ── Live transcript ── */
.call-transcript {
  width: 100%; max-height: 140px; min-height: 60px;
  overflow-y: auto; padding: 12px 0 0;
  border-top: 1px solid rgba(0,0,0,0.06);
  display: flex; flex-direction: column; gap: 6px;
}
.call-transcript:empty::before {
  content: '…'; display: block; text-align: center;
  color: rgba(0,0,0,0.2); font-size: 18px; letter-spacing: 4px; padding: 12px 0;
}
.call-transcript-msg {
  font-size: 13px; line-height: 1.5; color: var(--text);
  font-family: 'Polymath Text', 'DM Sans', sans-serif;
  padding: 2px 0;
}
.call-transcript-msg.agent {
  color: #5a8a74; font-weight: 500;
}
.call-transcript-msg.user {
  color: var(--muted); font-style: italic;
}
.call-transcript::-webkit-scrollbar { width: 4px; }
.call-transcript::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.12); border-radius: 2px; }

/* ── Bottom bar ── */
.call-bottombar {
  display: flex; align-items: center; justify-content: space-between;
  padding: 18px 28px 24px; flex-shrink: 0;
}
.call-powered {
  font-size: 11px; font-weight: 500; color: rgba(255,255,255,0.65);
  font-family: 'Polymath Text', 'DM Sans', sans-serif;
  letter-spacing: 0.3px;
}
.call-controls {
  display: flex; align-items: center; gap: 16px;
}
.call-mic-btn {
  width: 48px; height: 48px; border-radius: 50%;
  background: rgba(255,255,255,0.25); border: 2px solid rgba(255,255,255,0.5);
  cursor: pointer; display: flex; align-items: center; justify-content: center;
  transition: all 0.2s; backdrop-filter: blur(8px);
}
.call-mic-btn:hover { background: rgba(255,255,255,0.35); }
.call-mic-btn svg { width: 20px; height: 20px; fill: #fff; }
.call-mic-btn.muted { background: rgba(229,115,115,0.3); border-color: rgba(229,115,115,0.6); }
.call-end-btn {
  width: 52px; height: 52px; border-radius: 50%;
  background: #E57373; border: none; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.2s;
  box-shadow: 0 4px 16px rgba(229,115,115,0.35);
}
.call-end-btn:hover { background: #EF5350; transform: scale(1.06); box-shadow: 0 6px 20px rgba(229,115,115,0.5); }
.call-end-btn svg { width: 22px; height: 22px; fill: #fff; }
.call-info-btn {
  width: 36px; height: 36px; border-radius: 50%;
  background: rgba(255,255,255,0.18); border: none; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.2s;
}
.call-info-btn:hover { background: rgba(255,255,255,0.3); }
.call-info-btn svg { width: 18px; height: 18px; fill: rgba(255,255,255,0.7); }

.gen-loading {
  display: none; flex-direction: column; align-items: center; gap: 14px;
  padding: 56px 20px;
}
.gen-loading.on { display: flex; }
.gen-spin { width: 38px; height: 38px; border: 3px solid var(--pink-light); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
.gen-txt { font-size: 13.5px; color: var(--muted); font-weight: 500; }

/* ── Q STYLE ── */
.qstyle-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(185px,1fr)); gap: 9px; margin-bottom: 28px; }

/* ── DIVIDER ── */
.div { height: 1px; background: var(--border); margin: 24px 0; }

@media (max-width: 768px) {
  .sidebar { transform: translateX(-100%); }
  .main { margin-left: 0; }
  .main-inner { padding: 24px 18px 60px; }
}

/* ── TOAST NOTIFICATIONS ── */
.report-toast {
  position: fixed;
  bottom: 24px;
  right: 24px;
  z-index: 10000;
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 14px 20px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-left: 4px solid var(--blue);
  border-radius: var(--radius);
  font-size: 13.5px;
  color: var(--text);
  transform: translateX(calc(100% + 32px));
  opacity: 0;
  transition: transform 0.35s cubic-bezier(0.4,0,0.2,1), opacity 0.35s ease;
  pointer-events: none;
  max-width: 380px;
}
.report-toast.on {
  transform: translateX(0);
  opacity: 1;
  pointer-events: auto;
}
.report-toast.error { border-left-color: #E57373; }
.report-toast.success { border-left-color: var(--blue); }
.report-toast-icon {
  width: 20px; height: 20px; flex-shrink: 0;
}
.report-toast-icon.spin { animation: spin 1s linear infinite; }
.report-toast-msg { flex: 1; font-weight: 500; }
.report-toast-action {
  background: none; border: none; cursor: pointer;
  color: var(--blue); font-weight: 600; font-size: 13px;
  padding: 4px 8px; border-radius: var(--radius);
  white-space: nowrap;
}
.report-toast-action:hover { background: rgba(184,212,200,0.15); }
.report-toast-close {
  background: none; border: none; cursor: pointer;
  color: var(--muted); font-size: 18px; line-height: 1;
  padding: 2px 4px;
}
.report-toast-close:hover { color: var(--text); }

/* ── REPORTS: NAV BADGE ── */
.nav-badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 18px;
  height: 18px;
  padding: 0 5px;
  border-radius: 9px;
  background: var(--blue);
  color: white;
  font-size: 10.5px;
  font-weight: 700;
  margin-left: 6px;
  vertical-align: middle;
}

/* ── REPORTS LIST VIEW ── */
.reports-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 20px;
}
.reports-header h2 {
  font-size: 22px;
  font-weight: 700;
  color: var(--text);
  margin: 0;
}
.reports-table-wrap {
  overflow-x: auto;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  background: var(--surface);
}
.reports-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13.5px;
}
.reports-table thead tr {
  background: #F5F2ED;
}
.reports-table th {
  padding: 11px 16px;
  text-align: left;
  font-weight: 600;
  font-size: 11.5px;
  text-transform: uppercase;
  letter-spacing: 0.4px;
  color: var(--muted);
  border-bottom: 1px solid var(--border);
  white-space: nowrap;
}
.reports-table th:last-child {
  text-align: center;
  width: 90px;
}
.reports-row {
  transition: background 0.15s;
}
.reports-row.clickable { cursor: pointer; }
.reports-row.clickable:hover { background: #FAF8F5; }
.reports-cell {
  padding: 13px 16px;
  border-bottom: 1px solid #F0EDE8;
  color: var(--text);
  vertical-align: middle;
}
.reports-cell.actions {
  text-align: center;
  white-space: nowrap;
}
.reports-row:last-child .reports-cell { border-bottom: none; }

/* Badges */
.report-badge {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  padding: 3px 10px;
  border-radius: 20px;
  font-size: 11.5px;
  font-weight: 600;
  white-space: nowrap;
}
.report-badge.generating {
  background: #FFF3E0;
  color: #E65100;
  animation: pulse-badge 1.8s ease-in-out infinite;
}
.report-badge.ready {
  background: rgba(184,212,200,0.25);
  color: #2E7D59;
}
.report-badge.error {
  background: #FFEBEE;
  color: #C62828;
}
@keyframes pulse-badge {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.55; }
}

.report-score-mini {
  display: inline-block;
  margin-left: 6px;
  padding: 1px 7px;
  border-radius: 10px;
  background: rgba(184,212,200,0.2);
  color: #2E7D59;
  font-size: 11px;
  font-weight: 600;
}

/* Action buttons in table */
.report-action-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 28px;
  height: 28px;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  background: var(--surface);
  cursor: pointer;
  font-size: 14px;
  color: var(--muted);
  transition: all 0.15s;
  margin: 0 2px;
}
.report-action-btn:hover {
  border-color: var(--text);
  color: var(--text);
}
.report-action-btn.delete:hover {
  border-color: #E57373;
  color: #E57373;
  background: #FFF5F5;
}
.report-action-btn.retry:hover {
  border-color: var(--blue);
  color: var(--blue);
  background: rgba(184,212,200,0.1);
}

/* Empty state */
.reports-empty {
  text-align: center;
  padding: 80px 32px;
  color: var(--muted);
}
.reports-empty-icon {
  font-size: 48px;
  margin-bottom: 16px;
  opacity: 0.5;
}
.reports-empty h2 {
  font-size: 20px;
  color: var(--text);
  margin: 0 0 8px;
}
.reports-empty p {
  font-size: 14px;
  max-width: 360px;
  margin: 0 auto;
  line-height: 1.6;
}

/* ── REPORT DETAIL VIEW ── */
.report-detail {
  max-width: 860px;
  margin: 0 auto;
}

/* Action bar */
.report-action-bar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 24px;
  gap: 12px;
}
.report-action-bar.bottom {
  margin-top: 32px;
  margin-bottom: 0;
  padding-top: 24px;
  border-top: 1px solid var(--border);
}
.report-back-btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 9px 18px;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  background: var(--surface);
  color: var(--text);
  font-size: 13.5px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.15s;
}
.report-back-btn:hover {
  border-color: var(--text);
  background: #FAF8F5;
}
.report-download-btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 9px 18px;
  border: none;
  border-radius: var(--radius);
  background: var(--blue);
  color: white;
  font-size: 13.5px;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.15s;
}
.report-download-btn:hover { background: #9DC4B4; }

/* Report header */
.report-header {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: 20px;
  padding: 28px 32px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  margin-bottom: 20px;
}
.report-title {
  font-size: 22px;
  font-weight: 700;
  color: var(--text);
  margin: 0 0 6px;
}
.report-date {
  font-size: 13px;
  color: var(--muted);
}
.report-rec-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 18px;
  border-radius: 20px;
  font-size: 13px;
  font-weight: 700;
  white-space: nowrap;
}
.rec-advance {
  background: rgba(184,212,200,0.25);
  color: #2E7D59;
}
.rec-hold {
  background: #FFF3E0;
  color: #E65100;
}
.rec-reject {
  background: #FFEBEE;
  color: #C62828;
}

/* Report sections */
.report-section {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 24px 28px;
  margin-bottom: 16px;
}
.report-section h3 {
  font-size: 15px;
  font-weight: 700;
  color: var(--text);
  margin: 0 0 16px;
  text-transform: uppercase;
  letter-spacing: 0.3px;
}

/* Candidate profile */
.report-candidate {
  display: flex;
  align-items: center;
  gap: 18px;
}
.candidate-avatar {
  width: 56px;
  height: 56px;
  border-radius: 50%;
  background: var(--blue);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  font-weight: 700;
  flex-shrink: 0;
}
.candidate-name {
  font-size: 17px;
  font-weight: 700;
  color: var(--text);
}
.candidate-role {
  font-size: 13.5px;
  color: var(--muted);
  margin-top: 2px;
}
.candidate-meta {
  font-size: 12.5px;
  color: var(--muted);
  margin-top: 4px;
}

/* Score section (ring + bar chart side by side) */
.report-score-section {
  display: flex;
  gap: 32px;
  align-items: flex-start;
}
.report-score-left {
  flex: 0 0 180px;
  text-align: center;
}
.report-score-left .score-ring { margin: 8px auto 10px; display: block; }
.score-label {
  font-size: 13.5px;
  font-weight: 700;
  text-align: center;
}
.report-score-right {
  flex: 1;
  min-width: 0;
}

/* Bar chart */
.bar-chart { display: flex; flex-direction: column; gap: 10px; }
.bar-row {
  display: flex;
  align-items: center;
  gap: 10px;
}
.bar-label {
  flex: 0 0 130px;
  font-size: 12.5px;
  font-weight: 500;
  color: var(--text);
  text-align: right;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.bar-track {
  flex: 1;
  height: 10px;
  background: #F0EDE8;
  border-radius: 5px;
  overflow: hidden;
}
.bar-fill {
  height: 100%;
  border-radius: 5px;
  transition: width 0.6s ease;
}
.bar-value {
  flex: 0 0 32px;
  font-size: 12px;
  font-weight: 600;
  color: var(--muted);
}

/* Summary card */
.summary-card {
  padding: 18px 22px;
  background: #FAF8F5;
  border: 1px solid #F0EDE8;
  border-radius: var(--radius);
  font-size: 13.5px;
  line-height: 1.7;
  color: var(--text);
}

/* Skill cards grid */
.skill-cards-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
  gap: 14px;
}
.skill-card {
  background: #FAF8F5;
  border: 1px solid #F0EDE8;
  border-radius: var(--radius);
  padding: 16px 18px;
}
.skill-card-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 10px;
}
.skill-card-name {
  font-size: 13.5px;
  font-weight: 700;
  color: var(--text);
}
.skill-card-score {
  padding: 2px 10px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 700;
}
.skill-card-eval {
  font-size: 12.5px;
  line-height: 1.6;
  color: #555;
  margin: 0;
}

/* Sentiment */
.sentiment-wrap {
  display: flex;
  align-items: center;
  gap: 24px;
}
.sentiment-svg {
  flex: 1;
  max-height: 120px;
}
.sentiment-avg {
  text-align: center;
  flex-shrink: 0;
}
.sentiment-avg-num {
  display: block;
  font-size: 28px;
  font-weight: 800;
}
.sentiment-avg-lbl {
  font-size: 12px;
  color: var(--muted);
}

/* Strengths / Concerns / Red Flags list cards */
.list-cards {
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.list-card {
  padding: 12px 18px;
  border-radius: var(--radius);
  font-size: 13.5px;
  line-height: 1.5;
  border-left: 4px solid;
}
.list-card.strength {
  background: rgba(184,212,200,0.12);
  border-left-color: var(--blue);
  color: #2E7D59;
}
.list-card.concern {
  background: #FFF8E1;
  border-left-color: var(--orange);
  color: #E65100;
}
.list-card.flag {
  background: #FFEBEE;
  border-left-color: #E57373;
  color: #C62828;
}

/* Candidate feedback */
.feedback-card {
  padding: 18px 22px;
  background: rgba(197,202,233,0.12);
  border: 1px solid rgba(197,202,233,0.3);
  border-left: 4px solid var(--lavender);
  border-radius: var(--radius);
  font-size: 14px;
  font-style: italic;
  line-height: 1.7;
  color: var(--text);
}

/* Transcript accordion */
.transcript-accordion {
  border: none;
  background: none;
  padding: 0;
}
.transcript-toggle {
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  color: var(--text);
  padding: 10px 0;
  list-style: none;
  display: flex;
  align-items: center;
  gap: 8px;
}
.transcript-toggle::-webkit-details-marker { display: none; }
.transcript-toggle::before {
  content: '▶';
  font-size: 10px;
  color: var(--muted);
  transition: transform 0.2s;
}
details[open] .transcript-toggle::before { transform: rotate(90deg); }
.transcript-body {
  margin-top: 12px;
  max-height: 500px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 8px;
  padding-right: 8px;
}
.transcript-msg {
  padding: 10px 14px;
  border-radius: var(--radius);
  font-size: 13px;
  line-height: 1.55;
}
.transcript-msg.agent {
  background: #F0EDE8;
  color: var(--text);
  align-self: flex-start;
  max-width: 85%;
}
.transcript-msg.user {
  background: rgba(184,212,200,0.18);
  color: var(--text);
  align-self: flex-end;
  max-width: 85%;
}
.transcript-speaker {
  font-size: 11px;
  font-weight: 600;
  margin-bottom: 4px;
  color: var(--muted);
}
.transcript-text { word-wrap: break-word; }

/* ── PRINT / PDF EXPORT ── */
@media print {
  /* Hide everything except the report detail */
  body * { visibility: hidden; }
  .report-detail, .report-detail * { visibility: visible; }
  .report-detail {
    position: absolute;
    left: 0;
    top: 0;
    width: 100%;
    max-width: 100%;
    margin: 0;
    padding: 24px;
  }

  /* Hide interactive elements */
  .report-action-bar, .report-toast, .sidebar, .top-bar, .shell > *:not(main) {
    display: none !important;
  }

  /* Clean white background */
  body, html { background: white !important; }
  .report-section { break-inside: avoid; border: 1px solid #ddd; }
  .report-header { break-inside: avoid; }

  /* Expand transcript */
  .transcript-body { max-height: none !important; overflow: visible !important; }
  .transcript-accordion[open] .transcript-body { max-height: none !important; }

  /* Score ring adjustments */
  .report-score-section { break-inside: avoid; }

  /* Remove hover effects */
  .report-back-btn, .report-download-btn { display: none !important; }

  /* Page settings */
  @page {
    margin: 0.75in;
    size: A4;
  }
}

/* ── RESPONSIVE ADJUSTMENTS ── */
@media (max-width: 700px) {
  .report-score-section { flex-direction: column; }
  .report-score-left { flex: none; }
  .bar-label { flex: 0 0 90px; font-size: 11.5px; }
  .skill-cards-grid { grid-template-columns: 1fr; }
  .report-header { flex-direction: column; }
  .sentiment-wrap { flex-direction: column; }
}
</style>
</head>
<body>
<div class="shell">

<!-- ═══════════ SIDEBAR ═══════════ -->
<aside class="sidebar">
  <div class="sidebar-head">
    <div class="tp-logo">
      <img src="images/talkpush_logo_white.png"
           alt="Talkpush"
           style="height:28px;width:auto"
           onerror="this.style.display='none';document.getElementById('logo-fb').style.display='flex'">
      <div id="logo-fb" class="tp-logo-txt" style="display:none">talk<span>push</span></div>
    </div>
    <div class="live-pill" id="live-pill-txt">
      <div class="live-dot"></div>
      <span id="live-txt">Live Demo</span>
    </div>
  </div>
  <nav class="sidebar-nav" id="sidebar-nav"></nav>
  <div class="sidebar-foot">
    <div class="lang-row">
      <span class="lang-label" id="lang-lbl">Lang</span>
      <div class="lang-toggle">
        <button class="lang-btn active" onclick="setLang('en')" id="btn-en">EN</button>
        <button class="lang-btn" onclick="setLang('es')" id="btn-es">ES</button>
      </div>
    </div>
  </div>
</aside>

<!-- ═══════════ MAIN ═══════════ -->
<main class="main">
<div class="main-inner">

<!-- ── STEP 0: Job Role ── -->
<div class="step" id="step-0">
  <div class="phead">
    <div class="step-pill" id="s0-pill">Step 1 of 6</div>
    <h1 class="ptitle" id="s0-title">Choose the <em>Job Role</em></h1>
    <p class="pdesc" id="s0-desc">What position is this AI interview designed to screen for?</p>
  </div>
  <div class="cards" id="jobrole-grid"></div>
  <div class="step-nav">
    <div></div>
    <button class="btn-primary" id="btn-next-0" onclick="next(0)" disabled>Continue →</button>
  </div>
</div>

<!-- ── STEP 1: Soft Skills ── -->
<div class="step" id="step-1">
  <div class="phead">
    <div class="step-pill" id="s1-pill">Step 2 of 6</div>
    <h1 class="ptitle" id="s1-title">Select <em>Soft Skills</em></h1>
    <p class="pdesc" id="s1-desc">Choose the skills the AI will evaluate. More skills = deeper interview.</p>
  </div>
  <div class="skills-panel">
    <div class="sp-count-col">
      <div class="sp-label" id="sp-sel-lbl">Selected</div>
      <div class="sp-big" id="sp-count">0</div>
      <div class="sp-sub" id="sp-sub-lbl">Pick at least 1</div>
    </div>
    <div class="sp-tiers-col">
      <div class="sp-label" id="sp-depth-lbl">Interview Depth</div>
      <div class="tiers" id="tiers-display"></div>
    </div>
  </div>
  <div class="skills-grid" id="skills-grid"></div>
  <div class="step-nav">
    <button class="btn-ghost" onclick="prev(1)">← Back</button>
    <button class="btn-primary" id="btn-next-1" onclick="next(1)" disabled>Continue →</button>
  </div>
</div>

<!-- ── STEP 2: Question Style ── -->
<div class="step" id="step-2">
  <div class="phead">
    <div class="step-pill" id="s2-pill">Step 3 of 6</div>
    <h1 class="ptitle" id="s2-title">Question <em>Style</em></h1>
    <p class="pdesc" id="s2-desc">What type of questions should the AI interviewer ask?</p>
  </div>
  <div class="qstyle-grid" id="qstyle-grid"></div>
  <div class="step-nav">
    <button class="btn-ghost" onclick="prev(2)">← Back</button>
    <button class="btn-primary" id="btn-next-2" onclick="next(2)" disabled>Continue →</button>
  </div>
</div>

<!-- ── STEP 3: Select Questions ── -->
<div class="step" id="step-3">
  <div class="phead">
    <div class="step-pill" id="s3-pill">Step 4 of 6</div>
    <h1 class="ptitle" id="s3-title">Pick Your <em>Questions</em></h1>
    <p class="pdesc" id="s3-desc">We'll generate 10 tailored questions. Select the ones that best fit your interview.</p>
  </div>
  <div id="numq-hint-box" class="numq-hint"></div>
  <div class="q-select-panel">
    <div class="q-select-header">
      <div class="q-select-title" id="qs-title-txt">AI-Generated Interview Questions</div>
      <div class="q-count-badge" id="qs-count-badge">0 selected</div>
    </div>
    <div id="q-content">
      <div class="q-loading" id="q-loading-state">
        <div class="q-mini-spinner"></div>
        <div class="q-loading-text" id="q-loading-txt">Generating tailored questions…</div>
      </div>
      <div class="q-list" id="q-list" style="display:none"></div>
    </div>
    <div class="q-select-footer">
      <div class="q-sel-count" id="q-sel-count-txt"><b id="q-sel-n">0</b> questions selected</div>
      <div style="font-size:11px;color:var(--muted)" id="q-max-txt"></div>
    </div>
  </div>
  <div class="step-nav">
    <button class="btn-ghost" onclick="prev(3)">← Back</button>
    <button class="btn-primary" id="btn-next-3" onclick="next(3)" disabled>Continue →</button>
  </div>
</div>

<!-- ── STEP 4: Persona ── -->
<div class="step" id="step-4">
  <div class="phead">
    <div class="step-pill" id="s4-pill">Step 5 of 6</div>
    <h1 class="ptitle" id="s4-title">AI Agent <em>Persona</em></h1>
    <p class="pdesc" id="s4-desc">Choose the tone and personality of your AI interviewer.</p>
  </div>
  <div class="persona-grid" id="persona-grid"></div>
  <div class="step-nav">
    <button class="btn-ghost" onclick="prev(4)">← Back</button>
    <button class="btn-primary" id="btn-next-4" onclick="next(4)" disabled>Continue →</button>
  </div>
</div>

<!-- ── STEP 5: Generate ── -->
<div class="step" id="step-5">
  <div class="phead">
    <div class="step-pill" id="s5-pill">Step 6 of 6</div>
    <h1 class="ptitle" id="s5-title">Review & <em>Generate</em></h1>
    <p class="pdesc" id="s5-desc">Confirm your setup and generate the full AI interview configuration.</p>
  </div>
  <div class="sum-card">
    <div class="sum-heading" id="sum-heading">Configuration Summary</div>
    <div class="sum-tags" id="sum-tags"></div>
  </div>
  <div class="gen-loading" id="gen-loading">
    <div class="gen-spin"></div>
    <div class="gen-txt" id="gen-loading-txt">Building your interview configuration…</div>
  </div>
  <button class="btn-gen" id="btn-gen" onclick="generateInterview()">
    <div class="btn-spin"></div>
    <span id="btn-gen-txt">✨ Generate Interview Configuration</span>
  </button>
  <div class="step-nav" style="margin-top:16px">
    <button class="btn-ghost" onclick="prev(5)">← Back</button>
    <div></div>
  </div>
</div>

<!-- ── STEP 6: Output ── -->
<div class="step" id="step-6">
  <div class="out-bar">
    <div class="out-done" id="out-done-badge">✓ Interview Ready</div>
    <button class="restart-btn" onclick="restart()" id="restart-txt">↩ Start Over</button>
  </div>
  <div class="out-blocks" id="out-blocks"></div>
  <button class="copy-all" onclick="copyAll()" id="copy-all-txt">📋 Copy Complete System Prompt</button>

  <!-- Test Interview Section -->
  <div class="test-section" id="test-section">
    <div class="test-header">
      <div class="test-title" id="test-title">🎙️ Test Your Interview</div>
      <div class="test-desc" id="test-desc">Try a live voice call with the AI interviewer using the prompt you just built.</div>
    </div>
    <div class="test-name-row">
      <label class="test-name-label" id="test-name-label" for="test-candidate-name">Candidate Name:</label>
      <input class="test-name-input" id="test-candidate-name" type="text" value="Test Candidate" placeholder="Enter candidate name…" />
    </div>
    <button class="test-call-btn" id="test-call-btn" onclick="startTestInterview()">
      <span id="test-call-txt">📞 Start Test Interview</span>
    </button>
  </div>

  <!-- Call Overlay (fullscreen ElevenLabs-style) -->
  <div class="call-overlay" id="call-overlay">
    <!-- Top bar: role + timer | signal -->
    <div class="call-topbar">
      <div class="call-topbar-left">
        <span id="call-topbar-role">AI Interviewer</span>
        <span class="call-topbar-sep">|</span>
        <span class="call-topbar-timer" id="call-timer">00:00</span>
      </div>
      <div class="call-topbar-right">
        <div class="call-signal-bar"></div>
        <div class="call-signal-bar"></div>
        <div class="call-signal-bar"></div>
        <div class="call-signal-bar"></div>
      </div>
    </div>

    <!-- Center: card with orb, status, transcript -->
    <div class="call-center">
      <div class="call-card">
        <div class="call-agent-label" id="call-agent-label">AI Interviewer</div>
        <div class="call-orb-wrap">
          <div class="call-orb"></div>
        </div>
        <div class="call-status-badge" id="call-status-badge">
          <span class="call-status-dot" id="call-status-dot"></span>
          <span id="call-status-txt">Connecting…</span>
        </div>
        <div class="call-transcript" id="call-transcript"></div>
      </div>
    </div>

    <!-- Bottom bar: powered | mic + end | info -->
    <div class="call-bottombar">
      <div class="call-powered" id="call-powered">Powered by talkpush</div>
      <div class="call-controls">
        <button class="call-mic-btn" id="call-mic-btn" onclick="toggleMic()" title="Toggle Mic">
          <svg viewBox="0 0 24 24" id="mic-icon"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1-9c0-.55.45-1 1-1s1 .45 1 1v6c0 .55-.45 1-1 1s-1-.45-1-1V5zm6 6c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
        </button>
        <button class="call-end-btn" id="call-end-btn" onclick="endTestInterview()" title="End Call">
          <svg viewBox="0 0 24 24"><path d="M12 9c-1.6 0-3.15.25-4.6.72v3.1c0 .39-.23.74-.56.9-.98.49-1.87 1.12-2.66 1.85-.18.18-.43.28-.7.28-.28 0-.53-.11-.71-.29L.29 13.08a.956.956 0 0 1-.29-.7c0-.28.11-.53.29-.71C3.34 8.78 7.46 7 12 7s8.66 1.78 11.71 4.67c.18.18.29.43.29.71 0 .28-.11.53-.29.71l-2.48 2.48c-.18.18-.43.29-.71.29-.27 0-.52-.1-.7-.28-.79-.73-1.68-1.36-2.66-1.85a.994.994 0 0 1-.56-.9v-3.1C15.15 9.25 13.6 9 12 9z"/></svg>
        </button>
      </div>
      <button class="call-info-btn" id="call-info-btn" title="Info">
        <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
      </button>
    </div>

  </div>
</div>

<!-- ── STEP 7: Reports ── -->
<div class="step" id="step-7">
  <div id="reports-container"></div>
</div>

</div>
</main>
</div>

<script>
// ═══════════════════════════════
//  I18N
// ═══════════════════════════════
const CUR = { lang: 'en' };
const T = {
  en: {
    live: 'Live Demo',
    langLbl: 'Lang',
    navLabels: ['Job Role','Soft Skills','Q. Style','Questions','Persona','Generate','Output','Reports'],
    steps: [
      { pill:'Step 1 of 6', title:'Choose the <em>Job Role</em>', desc:'What position is this AI interview designed to screen for?' },
      { pill:'Step 2 of 6', title:'Select <em>Soft Skills</em>', desc:'Choose the skills the AI will evaluate. More skills = deeper interview.' },
      { pill:'Step 3 of 6', title:'Question <em>Style</em>', desc:'What type of questions should the AI interviewer ask?' },
      { pill:'Step 4 of 6', title:'Pick Your <em>Questions</em>', desc:'We generated 10 tailored questions. Select the ones you want included.' },
      { pill:'Step 5 of 6', title:'AI Agent <em>Persona</em>', desc:'Choose the tone and personality of your AI interviewer.' },
      { pill:'Step 6 of 6', title:'Review & <em>Generate</em>', desc:'Confirm your setup and generate the full AI interview configuration.' },
    ],
    spSel:'Selected', spSub:'Pick at least 1', spDepth:'Interview Depth',
    sumHeading:'Configuration Summary',
    genBtn:'✨ Generate Interview Configuration',
    genLoading:'Building your interview configuration…',
    outDone:'✓ Interview Ready', restart:'↩ Start Over',
    copyAll:'📋 Copy Complete System Prompt',
    copy:'Copy', copied:'Copied!',
    continueBtn:'Continue →',
    qGenTitle:'AI-Generated Interview Questions',
    qLoading:'Generating tailored questions…',
    qSelCount:'questions selected',
    qMaxTxt:(n,max)=>`Select ${n} to ${max} questions`,
    qCountBadge:(n)=>`${n} selected`,
    testTitle:'🎙️ Test Your Interview',
    testDesc:'Try a live voice call with the AI interviewer using the prompt you just built.',
    testNameLabel:'Candidate Name:',
    testNamePlaceholder:'Enter candidate name…',
    testCallBtn:'📞 Start Test Interview',
    testConnecting:'Connecting…',
    testListening:'Listening…',
    testSpeaking:'AI is speaking…',
    testEndBtn:'End Call',
    testError:'Call failed. Please try again.',
    testMicDenied:'Microphone access is required for the test call.',
    callAgentLabel:'AI Interviewer',
    callTopbarRole:'AI Interviewer',
    callPoweredBy:'Powered by talkpush',
    reportsNav:'Reports',
    reportsTitle:'Interview Reports',
    reportsEmpty:'No reports yet. Complete a test interview to generate your first report.',
    reportsColRole:'Interview Type',
    reportsColCandidate:'Candidate',
    reportsColDate:'Date & Time',
    reportsColStatus:'Status',
    reportsColActions:'Actions',
    reportStatusGenerating:'Generating...',
    reportStatusReady:'Ready',
    reportStatusError:'Error',
    reportToastGenerating:'Generating interview report...',
    reportToastReady:'Report ready!',
    reportToastView:'View',
    reportToastError:'Report generation failed',
    reportDetailTitle:'Talkscore Assessment Report',
    reportDetailBack:'Back to Reports',
    reportDetailDownload:'Download PDF',
    reportDetailOverall:'Overall Score',
    reportDetailSummary:'Assessment Summary',
    reportDetailSkills:'Skill Assessment',
    reportDetailSentiment:'Sentiment Analysis',
    reportDetailStrengths:'Strengths',
    reportDetailConcerns:'Areas of Concern',
    reportDetailRedFlags:'Red Flags',
    reportDetailFeedback:'Candidate Feedback',
    reportDetailTranscript:'Transcript',
    reportDetailRecommend:'Recommendation',
    reportDeleteConfirm:'Delete this report?',
    reportRetry:'Retry',
    reportDetailCandidate:'Candidate Profile',
    reportDetailDuration:'Call Duration',
    reportAdvance:'Advance',
    reportHold:'Hold',
    reportReject:'Reject',
  },
  es: {
    live: 'Demo en Vivo',
    langLbl: 'Idioma',
    navLabels: ['Puesto','Habilidades','Estilo','Preguntas','Persona','Generar','Resultado','Reportes'],
    steps: [
      { pill:'Paso 1 de 6', title:'Elige el <em>Puesto</em>', desc:'¿Para qué rol está diseñada esta entrevista de IA?' },
      { pill:'Paso 2 de 6', title:'Selecciona <em>Habilidades Blandas</em>', desc:'Las habilidades elegidas determinan la profundidad de la entrevista.' },
      { pill:'Paso 3 de 6', title:'Estilo de <em>Preguntas</em>', desc:'¿Qué tipo de preguntas debe hacer el agente de IA?' },
      { pill:'Paso 4 de 6', title:'Elige tus <em>Preguntas</em>', desc:'Generamos 10 preguntas personalizadas. Selecciona las que quieres incluir.' },
      { pill:'Paso 5 de 6', title:'Persona del <em>Agente IA</em>', desc:'Elige el tono y la personalidad de tu entrevistador virtual.' },
      { pill:'Paso 6 de 6', title:'Revisar y <em>Generar</em>', desc:'Confirma tu configuración y genera el prompt completo de la entrevista.' },
    ],
    spSel:'Seleccionadas', spSub:'Elige al menos 1', spDepth:'Profundidad',
    sumHeading:'Resumen de Configuración',
    genBtn:'✨ Generar Configuración de Entrevista',
    genLoading:'Construyendo tu configuración de entrevista…',
    outDone:'✓ Entrevista Lista', restart:'↩ Comenzar de nuevo',
    copyAll:'📋 Copiar Prompt Completo',
    copy:'Copiar', copied:'¡Copiado!',
    continueBtn:'Continuar →',
    qGenTitle:'Preguntas Generadas por IA',
    qLoading:'Generando preguntas personalizadas…',
    qSelCount:'preguntas seleccionadas',
    qMaxTxt:(n,max)=>`Selecciona de ${n} a ${max} preguntas`,
    qCountBadge:(n)=>`${n} seleccionadas`,
    testTitle:'🎙️ Prueba tu Entrevista',
    testDesc:'Realiza una llamada de voz en vivo con el entrevistador IA usando el prompt que acabas de crear.',
    testNameLabel:'Nombre del Candidato:',
    testNamePlaceholder:'Ingresa el nombre del candidato…',
    testCallBtn:'📞 Iniciar Entrevista de Prueba',
    testConnecting:'Conectando…',
    testListening:'Escuchando…',
    testSpeaking:'La IA está hablando…',
    testEndBtn:'Finalizar Llamada',
    testError:'La llamada falló. Inténtalo de nuevo.',
    testMicDenied:'Se requiere acceso al micrófono para la llamada de prueba.',
    callAgentLabel:'Entrevistador IA',
    callTopbarRole:'Entrevistador IA',
    callPoweredBy:'Desarrollado por talkpush',
    reportsNav:'Reportes',
    reportsTitle:'Reportes de Entrevista',
    reportsEmpty:'Sin reportes. Completa una entrevista de prueba para generar tu primer reporte.',
    reportsColRole:'Tipo de Entrevista',
    reportsColCandidate:'Candidato',
    reportsColDate:'Fecha y Hora',
    reportsColStatus:'Estado',
    reportsColActions:'Acciones',
    reportStatusGenerating:'Generando...',
    reportStatusReady:'Listo',
    reportStatusError:'Error',
    reportToastGenerating:'Generando reporte de entrevista...',
    reportToastReady:'¡Reporte listo!',
    reportToastView:'Ver',
    reportToastError:'Error al generar reporte',
    reportDetailTitle:'Reporte de Evaluacion Talkscore',
    reportDetailBack:'Volver a Reportes',
    reportDetailDownload:'Descargar PDF',
    reportDetailOverall:'Puntuacion General',
    reportDetailSummary:'Resumen de Evaluacion',
    reportDetailSkills:'Evaluacion de Habilidades',
    reportDetailSentiment:'Analisis de Sentimiento',
    reportDetailStrengths:'Fortalezas',
    reportDetailConcerns:'Areas de Mejora',
    reportDetailRedFlags:'Senales de Alerta',
    reportDetailFeedback:'Retroalimentacion del Candidato',
    reportDetailTranscript:'Transcripcion',
    reportDetailRecommend:'Recomendacion',
    reportDeleteConfirm:'¿Eliminar este reporte?',
    reportRetry:'Reintentar',
    reportDetailCandidate:'Perfil del Candidato',
    reportDetailDuration:'Duracion de Llamada',
    reportAdvance:'Avanzar',
    reportHold:'En espera',
    reportReject:'Rechazar',
  }
};
function t(k,...a){ const v=T[CUR.lang][k]; return typeof v==='function'?v(...a):v; }

// ═══════════════════════════════
//  DATA
// ═══════════════════════════════
const DATA = {
  roles:[
    {id:'csr',icon:'🎧',en:'Customer Service Rep.',es:'Servicio al Cliente',dEn:'Front-line support: inquiries, complaints, and resolutions',dEs:'Soporte de primera línea: consultas, quejas y resoluciones'},
    {id:'retail',icon:'🛍️',en:'Retail',es:'Comercio al por Menor',dEn:'In-store experience, floor sales, and product knowledge',dEs:'Experiencia en tienda, ventas y conocimiento de producto'},
    {id:'collections',icon:'💳',en:'Collections Agent',es:'Agente de Cobranza',dEn:'Negotiating payment recovery with empathy and compliance',dEs:'Negociación de cobros con empatía y cumplimiento normativo'},
    {id:'techsupport',icon:'🖥️',en:'Technical Support',es:'Soporte Técnico',dEn:'Troubleshooting software, hardware, and systems',dEs:'Diagnóstico y resolución de problemas técnicos'},
    {id:'sales',icon:'📈',en:'Sales Agent',es:'Agente de Ventas',dEn:'Consultative inbound/outbound selling and pipeline management',dEs:'Ventas consultivas y gestión de pipeline'},
    {id:'logistics',icon:'📦',en:'Logistics Assistant',es:'Asistente de Logística',dEn:'Supply chain coordination, shipments, and operations',dEs:'Coordinación de cadena de suministro y operaciones'},
    {id:'hr',icon:'🤝',en:'HR / People Ops',es:'RRHH / Personas',dEn:'Talent acquisition, culture building, and employee experience',dEs:'Adquisición de talento, cultura y experiencia del empleado'},
    {id:'callcenter',icon:'📞',en:'Call Center',es:'Call Center',dEn:'High-volume inbound and outbound phone interactions',dEs:'Interacciones telefónicas de alto volumen'},
  ],
  skills:{
    csr:[
      {id:'empathy',en:'Empathy',es:'Empatía',dEn:'Builds trust & de-escalates tense customer situations',dEs:'Genera confianza y reduce tensiones'},
      {id:'patience',en:'Patience',es:'Paciencia',dEn:'Stays composed during frustrated or repetitive contacts',dEs:'Mantiene la calma ante contactos difíciles'},
      {id:'comm',en:'Communication',es:'Comunicación',dEn:'Clear speech and writing directly impact satisfaction scores',dEs:'La comunicación clara impacta la satisfacción'},
      {id:'prob',en:'Problem Solving',es:'Resolución de Problemas',dEn:'Fast, accurate solutions drive first-contact resolution',dEs:'Las soluciones rápidas determinan la resolución en el primer contacto'},
      {id:'active',en:'Active Listening',es:'Escucha Activa',dEn:'Prevents misdiagnosis and repeat contacts',dEs:'Previene errores y recontactos'},
      {id:'adapt',en:'Adaptability',es:'Adaptabilidad',dEn:'Adjusts to different customer types and policy changes',dEs:'Se adapta a diferentes tipos de clientes'},
      {id:'resilience',en:'Resilience',es:'Resiliencia',dEn:'Recovers emotionally between difficult interactions',dEs:'Se recupera emocionalmente entre interacciones difíciles'},
      {id:'ownership',en:'Ownership',es:'Responsabilidad',dEn:'Follows through on issues rather than passing them along',dEs:'Da seguimiento en lugar de derivar problemas'},
      {id:'teamwork',en:'Teamwork',es:'Trabajo en Equipo',dEn:'Complex cases need smooth handoffs with back-office teams',dEs:'Los casos complejos requieren coordinación fluida'},
      {id:'stress',en:'Stress Management',es:'Manejo del Estrés',dEn:'High-volume environments require sustained composure',dEs:'Entornos de alto volumen exigen compostura sostenida'},
    ],
    retail:[
      {id:'empathy',en:'Empathy',es:'Empatía',dEn:'Reads customer cues to personalize the shopping experience',dEs:'Lee las señales del cliente para personalizar la experiencia'},
      {id:'comm',en:'Communication',es:'Comunicación',dEn:'Friendly clarity drives conversions and satisfaction',dEs:'La claridad amigable impulsa conversiones y satisfacción'},
      {id:'proact',en:'Proactivity',es:'Proactividad',dEn:'Anticipates customer needs without being asked',dEs:'Anticipa necesidades del cliente sin que pregunte'},
      {id:'teamwork',en:'Teamwork',es:'Trabajo en Equipo',dEn:'Smooth shift handoffs keep floor operations running',dEs:'Los traspasos de turno mantienen las operaciones en marcha'},
      {id:'adapt',en:'Adaptability',es:'Adaptabilidad',dEn:'Handles product changes, promotions, and peak seasons fast',dEs:'Gestiona cambios de producto y temporadas altas'},
      {id:'patience',en:'Patience',es:'Paciencia',dEn:'Handles indecisive or demanding customers calmly',dEs:'Maneja clientes indecisos o exigentes con calma'},
      {id:'salesori',en:'Sales Orientation',es:'Orientación a Ventas',dEn:'Motivated to upsell naturally and meet targets',dEs:'Motivado para cumplir metas y hacer upsell naturalmente'},
      {id:'integrity',en:'Integrity',es:'Integridad',dEn:'Honest handling of cash, returns, and inventory',dEs:'Manejo honesto de caja, devoluciones e inventario'},
      {id:'resilience',en:'Resilience',es:'Resiliencia',dEn:'Maintains energy through long shifts and high traffic',dEs:'Mantiene energía durante turnos largos y alto tráfico'},
      {id:'initiative',en:'Initiative',es:'Iniciativa',dEn:'Resolves floor issues without waiting for management',dEs:'Resuelve problemas sin esperar dirección de la gerencia'},
    ],
    collections:[
      {id:'negotiation',en:'Negotiation',es:'Negociación',dEn:'Core skill for reaching workable payment agreements',dEs:'Habilidad clave para acuerdos de pago viables'},
      {id:'empathy',en:'Empathy',es:'Empatía',dEn:'Understanding financial stress prevents aggression',dEs:'Entender el estrés financiero evita agresividad'},
      {id:'resilience',en:'Resilience',es:'Resiliencia',dEn:'Frequent rejection requires emotional strength',dEs:'El rechazo frecuente requiere fortaleza emocional'},
      {id:'comm',en:'Communication',es:'Comunicación',dEn:'Tone and word choice influence willingness to pay',dEs:'El tono influye en la disposición de pago'},
      {id:'integrity',en:'Integrity',es:'Integridad',dEn:'Regulatory compliance requires ethical behavior always',dEs:'El cumplimiento normativo requiere ética constante'},
      {id:'stress',en:'Stress Management',es:'Manejo del Estrés',dEn:'Emotionally charged calls demand self-regulation',dEs:'Las llamadas cargadas emocionalmente exigen autorregulación'},
      {id:'persist',en:'Persistence',es:'Persistencia',dEn:'Consistent follow-up is tied to payment recovery rates',dEs:'El seguimiento constante está ligado a las tasas de recuperación'},
      {id:'active',en:'Active Listening',es:'Escucha Activa',dEn:'Understanding the debtor\'s situation enables viable plans',dEs:'Entender la situación del deudor permite planes viables'},
      {id:'prob',en:'Problem Solving',es:'Resolución de Problemas',dEn:'Flexible arrangements increase recovery likelihood',dEs:'Los acuerdos flexibles aumentan la probabilidad de recuperación'},
      {id:'adapt',en:'Adaptability',es:'Adaptabilidad',dEn:'Each debtor is unique — scripts alone never work',dEs:'Cada deudor es único — los guiones solos no funcionan'},
    ],
    techsupport:[
      {id:'prob',en:'Problem Solving',es:'Resolución de Problemas',dEn:'Methodical diagnosis is the core function of the role',dEs:'El diagnóstico metódico es la función central del rol'},
      {id:'comm',en:'Communication',es:'Comunicación',dEn:'Translating tech jargon for non-technical users',dEs:'Traducir jerga técnica para usuarios no técnicos'},
      {id:'patience',en:'Patience',es:'Paciencia',dEn:'Walks frustrated users through complex troubleshooting',dEs:'Guía a usuarios frustrados en diagnósticos complejos'},
      {id:'learn',en:'Learning Agility',es:'Agilidad de Aprendizaje',dEn:'Technology evolves fast — continuous learning is essential',dEs:'La tecnología evoluciona rápido — el aprendizaje continuo es clave'},
      {id:'critical',en:'Critical Thinking',es:'Pensamiento Crítico',dEn:'Evaluating multiple root causes before jumping to solutions',dEs:'Evaluar múltiples causas raíz antes de llegar a soluciones'},
      {id:'ownership',en:'Ownership',es:'Responsabilidad',dEn:'Follows incidents to full resolution rather than escalating',dEs:'Da seguimiento hasta la resolución completa'},
      {id:'collab',en:'Collaboration',es:'Colaboración',dEn:'Complex issues need coordination with engineering teams',dEs:'Los problemas complejos requieren coordinación con ingeniería'},
      {id:'empathy',en:'Empathy',es:'Empatía',dEn:'Technical issues cause real disruption — acknowledging builds trust',dEs:'Los problemas técnicos causan disrupciones — reconocerlo genera confianza'},
      {id:'adapt',en:'Adaptability',es:'Adaptabilidad',dEn:'No two technical issues are identical — flexible thinking wins',dEs:'No hay dos problemas iguales — el pensamiento flexible triunfa'},
      {id:'stress',en:'Stress Management',es:'Manejo del Estrés',dEn:'High-stakes outages demand clear thinking under pressure',dEs:'Las fallas críticas exigen pensamiento claro bajo presión'},
    ],
    sales:[
      {id:'persuasion',en:'Persuasion',es:'Persuasión',dEn:'Influencing buying decisions with confidence drives revenue',dEs:'Influir en las decisiones de compra impulsa los ingresos'},
      {id:'resilience',en:'Resilience',es:'Resiliencia',dEn:'Rejection is daily — recovery speed defines performance',dEs:'El rechazo es diario — la velocidad de recuperación define el desempeño'},
      {id:'empathy',en:'Empathy',es:'Empatía',dEn:'Understanding pain points before pitching increases conversions',dEs:'Entender los puntos de dolor aumenta conversiones'},
      {id:'goaldriven',en:'Goal-Driven Mindset',es:'Orientación a Resultados',dEn:'Intrinsic motivation to hit targets without supervision',dEs:'Motivación intrínseca para alcanzar metas sin supervisión'},
      {id:'active',en:'Active Listening',es:'Escucha Activa',dEn:'Understanding needs before proposing any solution',dEs:'Entender necesidades antes de proponer soluciones'},
      {id:'adapt',en:'Adaptability',es:'Adaptabilidad',dEn:'Adjusts pitch and tone to different buyer profiles',dEs:'Ajusta el discurso a diferentes perfiles de compradores'},
      {id:'negotiation',en:'Negotiation',es:'Negociación',dEn:'Closing with mutual value requires skilled give-and-take',dEs:'Cerrar con valor mutuo requiere negociación hábil'},
      {id:'proact',en:'Proactivity',es:'Proactividad',dEn:'Hunts new opportunities rather than waiting for inbound leads',dEs:'Busca oportunidades en lugar de esperar leads'},
      {id:'comm',en:'Communication',es:'Comunicación',dEn:'Compelling storytelling and clear value propositions are fundamental',dEs:'El storytelling convincente y la propuesta de valor son fundamentales'},
      {id:'integrity',en:'Integrity',es:'Integridad',dEn:'Long-term relationships are built on honest, ethical selling',dEs:'Las relaciones duraderas se construyen con ventas honestas'},
    ],
    logistics:[
      {id:'org',en:'Organization',es:'Organización',dEn:'Managing shipments and timelines without errors requires rigor',dEs:'Gestionar envíos y plazos sin errores requiere rigor'},
      {id:'prob',en:'Problem Solving',es:'Resolución de Problemas',dEn:'Daily disruptions need contingency thinking to prevent delays',dEs:'Las interrupciones diarias requieren pensamiento de contingencia'},
      {id:'comm',en:'Communication',es:'Comunicación',dEn:'Coordinating clearly between suppliers, carriers, and teams',dEs:'Coordinar claramente entre proveedores, transportistas y equipos'},
      {id:'teamwork',en:'Teamwork',es:'Trabajo en Equipo',dEn:'Logistics is cross-functional — silos cause costly errors',dEs:'La logística es multifuncional — los silos causan errores costosos'},
      {id:'adapt',en:'Adaptability',es:'Adaptabilidad',dEn:'Supply chain disruptions require fast pivots and rerouting',dEs:'Las disrupciones requieren pivotes rápidos y enrutamiento creativo'},
      {id:'stress',en:'Stress Management',es:'Manejo del Estrés',dEn:'Tight deadlines and unexpected delays create constant pressure',dEs:'Los plazos ajustados crean presión constante'},
      {id:'attention',en:'Attention to Detail',es:'Atención al Detalle',dEn:'Small doc errors in logistics cause major downstream problems',dEs:'Los pequeños errores en documentos causan grandes problemas'},
      {id:'proact',en:'Proactivity',es:'Proactividad',dEn:'Identifying bottlenecks before they escalate saves time and cost',dEs:'Identificar cuellos de botella antes de que escalen ahorra tiempo'},
      {id:'ownership',en:'Ownership',es:'Responsabilidad',dEn:'Taking accountability when shipments fail accelerates resolution',dEs:'Asumir responsabilidad cuando hay errores acelera la resolución'},
      {id:'critical',en:'Critical Thinking',es:'Pensamiento Crítico',dEn:'Evaluating routes, costs, and risks requires analytical judgment',dEs:'Evaluar rutas, costos y riesgos requiere juicio analítico'},
    ],
    hr:[
      {id:'empathy',en:'Empathy',es:'Empatía',dEn:'Deep understanding of employee experience is HR\'s foundation',dEs:'La comprensión profunda de la experiencia del empleado es la base de RRHH'},
      {id:'confid',en:'Confidentiality',es:'Confidencialidad',dEn:'Sensitive info requires constant discretion — trust is HR\'s currency',dEs:'La discreción constante es la moneda de RRHH'},
      {id:'comm',en:'Communication',es:'Comunicación',dEn:'Articulating policy and feedback at all organizational levels',dEs:'Articular políticas y retroalimentación en todos los niveles'},
      {id:'influence',en:'Influence',es:'Influencia',dEn:'Driving change without formal authority is a core challenge',dEs:'Impulsar cambios sin autoridad formal es un desafío central'},
      {id:'integrity',en:'Integrity',es:'Integridad',dEn:'Ethical conduct in hiring and reviews is non-negotiable',dEs:'La conducta ética en contratación y evaluaciones es fundamental'},
      {id:'active',en:'Active Listening',es:'Escucha Activa',dEn:'Truly hearing employee concerns before proposing solutions',dEs:'Escuchar genuinamente antes de proponer soluciones'},
      {id:'critical',en:'Critical Thinking',es:'Pensamiento Crítico',dEn:'Complex people situations require nuanced, fair judgment',dEs:'Las situaciones complejas requieren juicio analítico y justo'},
      {id:'adapt',en:'Adaptability',es:'Adaptabilidad',dEn:'HR must pivot rapidly to restructuring, crises, and rapid growth',dEs:'RRHH debe adaptarse rápidamente a reestructuraciones y crisis'},
      {id:'org',en:'Organization',es:'Organización',dEn:'Managing hiring, reviews, and training initiatives simultaneously',dEs:'Gestionar contratación, evaluaciones y formación simultáneamente'},
      {id:'resilience',en:'Resilience',es:'Resiliencia',dEn:'Navigating emotionally intense situations without burning out',dEs:'Navegar situaciones emocionalmente intensas sin agotarse'},
    ],
    callcenter:[
      {id:'active',en:'Active Listening',es:'Escucha Activa',dEn:'Understanding caller intent quickly enables efficient resolution',dEs:'Entender la intención del llamante rápidamente es esencial'},
      {id:'resilience',en:'Resilience',es:'Resiliencia',dEn:'Recovering between back-to-back calls prevents quality drops',dEs:'Recuperarse entre llamadas consecutivas evita pérdidas de calidad'},
      {id:'comm',en:'Communication',es:'Comunicación',dEn:'Voice tone, pacing, and clarity are the only available tools',dEs:'Tono de voz, ritmo y claridad son las únicas herramientas disponibles'},
      {id:'empathy',en:'Empathy',es:'Empatía',dEn:'Callers often reach out stressed — empathy drives satisfaction',dEs:'Los llamantes contactan estresados — la empatía impulsa la satisfacción'},
      {id:'multitask',en:'Multitasking',es:'Multitarea',dEn:'Navigating CRM while maintaining natural conversation',dEs:'Navegar el CRM mientras se mantiene la conversación'},
      {id:'prob',en:'Problem Solving',es:'Resolución de Problemas',dEn:'Fast, accurate diagnosis while on-call minimizes handle time',dEs:'El diagnóstico rápido minimiza el tiempo de gestión'},
      {id:'adapt',en:'Adaptability',es:'Adaptabilidad',dEn:'Scripts are a starting point — every caller is different',dEs:'Los guiones son un punto de partida — cada llamante es diferente'},
      {id:'stress',en:'Stress Management',es:'Manejo del Estrés',dEn:'Back-to-back high-pressure calls demand emotional regulation',dEs:'Las llamadas de alta presión consecutivas demandan regulación emocional'},
      {id:'patience',en:'Patience',es:'Paciencia',dEn:'Repetitive questions and difficult callers test composure every shift',dEs:'Las preguntas repetitivas prueban la compostura en cada turno'},
      {id:'ownership',en:'Ownership',es:'Responsabilidad',dEn:'Following issues to resolution rather than transferring callers',dEs:'Dar seguimiento hasta la resolución en lugar de transferir llamadas'},
    ],
  },
  tiers:[
    {min:1,max:2,dur:'3–4 min',maxQ:'Max 3 Qs',minSel:1,maxSel:3},
    {min:3,max:4,dur:'4–7 min',maxQ:'Max 4 Qs',minSel:1,maxSel:4},
    {min:5,max:5,dur:'7–10 min',maxQ:'Max 5 Qs',minSel:1,maxSel:5},
    {min:6,max:10,dur:'10+ min',maxQ:'Up to 10 Qs',minSel:1,maxSel:10},
  ],
  qStyles:[
    {id:'situational',icon:'🎯',en:'Situational',es:'Situacional',dEn:'"What would you do if…" — scenario-based thinking',dEs:'¿Qué harías si…? — basadas en escenarios'},
    {id:'behavioral',icon:'📖',en:'Behavioral (STAR)',es:'Conductual (STAR)',dEn:'"Tell me about a time…" — experience-based evidence',dEs:'Cuéntame de una vez que… — basadas en experiencias'},
    {id:'skillsbased',icon:'🛠️',en:'Skills-Based',es:'Basado en Habilidades',dEn:'Direct assessment of job-specific capabilities',dEs:'Evaluación directa de habilidades del puesto'},
    {id:'culture',icon:'🌱',en:'Culture Fit',es:'Ajuste Cultural',dEn:'Values, motivation, and long-term team alignment',dEs:'Valores, motivación y alineación con el equipo'},
  ],
  personas:[
    {id:'alex',ico:'👔',bg:'#EFF6F3',col:'#3D7A5E',en:'Alex',es:'Alex',tEn:'Formal & Professional',tEs:'Formal y Profesional',trEn:'Structured and precise. Uses measured language and clear expectations. Best for corporate, managerial, and compliance-sensitive roles.',trEs:'Estructurado y preciso. Lenguaje medido. Ideal para roles corporativos y de gestión.'},
    {id:'sam',ico:'😊',bg:'#ECEEF7',col:'#7A82B3',en:'Sam',es:'Sam',tEn:'Friendly & Warm',tEs:'Amigable y Cálido',trEn:'Conversational and encouraging. Puts candidates at ease with inclusive language. Great for culture-first or customer-facing roles.',trEs:'Conversacional y alentador. Usa lenguaje inclusivo. Ideal para roles con foco en cultura o atención al cliente.'},
    {id:'jordan',ico:'⚡',bg:'#FDF5E6',col:'#D4920A',en:'Jordan',es:'Jordan',tEn:'Energetic & Dynamic',tEs:'Enérgico y Dinámico',trEn:'Fast-paced and enthusiastic. Mirrors high-performance environments like sales, retail, or call centers.',trEs:'Ritmo ágil y entusiasta. Refleja entornos de alto rendimiento como ventas o call center.'},
    {id:'morgan',ico:'⚖️',bg:'#F4F6FB',col:'#3A5080',en:'Morgan',es:'Morgan',tEn:'Neutral & Objective',tEs:'Neutral y Objetivo',trEn:'Balanced and methodical. Removes emotional signals to evaluate on demonstrated skills. Ideal for technical or analytical roles.',trEs:'Equilibrado y metódico. Evalúa por habilidades demostradas. Ideal para roles técnicos.'},
    {id:'luna',ico:'🌙',bg:'#F5EEFF',col:'#7B3FBE',en:'Luna',es:'Luna',tEn:'Empathetic & Supportive',tEs:'Empática y de Apoyo',trEn:'Patient and nurturing, creates psychological safety. Draws out authentic answers from nervous candidates. Best for HR or sensitive evaluations.',trEs:'Paciente y acogedora. Crea seguridad psicológica. Ideal para RRHH.'},
    {id:'victor',ico:'🦅',bg:'#FFF5EC',col:'#E67E22',en:'Victor',es:'Víctor',tEn:'Direct & Decisive',tEs:'Directo y Decisivo',trEn:'No-nonsense and results-oriented. Doesn\'t let vague answers pass. Best for leadership, operations, and collections.',trEs:'Sin rodeos, orientado a resultados. No deja pasar respuestas vagas. Ideal para liderazgo y cobranza.'},
    {id:'nova',ico:'🚀',bg:'#E5F9F3',col:'#00956A',en:'Nova',es:'Nova',tEn:'Innovative & Curious',tEs:'Innovadora y Curiosa',trEn:'Inquisitive and open-minded. Encourages creative thinking. Perfect for tech, logistics, or problem-solving roles.',trEs:'Inquisitiva y mente abierta. Fomenta el pensamiento creativo. Perfecta para tecnología y logística.'},
    {id:'rios',ico:'🔥',bg:'#FEECEA',col:'#C0392B',en:'Rios',es:'Ríos',tEn:'Intense & Challenging',tEs:'Intenso y Retador',trEn:'Pushes boundaries and raises stakes. Doesn\'t accept surface-level answers. Best for collections and high-pressure roles.',trEs:'Desafiante y eleva las apuestas. No acepta respuestas superficiales. Ideal para cobranza y roles de alta presión.'},
  ],
};

// ═══════════════════════════════
//  STATE
// ═══════════════════════════════
const S = {
  step: 0,
  role: null,
  skills: [],
  qStyle: null,
  questions: [],       // [{text, skill}] — all 10 from API
  selectedQs: [],      // indexes the user picked
  persona: null,
  output: null,
  sections: null,       // parsed JSON sections from GPT for ElevenLabs dynamicVariables
};

// ═══════════════════════════════
//  TIER HELPERS
// ═══════════════════════════════
function getTier(n){
  if(n<=2) return DATA.tiers[0];
  if(n<=4) return DATA.tiers[1];
  if(n===5) return DATA.tiers[2];
  return DATA.tiers[3];
}

// ═══════════════════════════════
//  LANG
// ═══════════════════════════════
function setLang(l){
  CUR.lang=l;
  document.getElementById('btn-en').classList.toggle('active',l==='en');
  document.getElementById('btn-es').classList.toggle('active',l==='es');
  refreshStaticText();
  renderStep(S.step);
}
function refreshStaticText(){
  const L=CUR.lang;
  document.getElementById('live-txt').textContent=t('live');
  document.getElementById('lang-lbl').textContent=t('langLbl');
  renderSidebar();
}

// ═══════════════════════════════
//  SIDEBAR
// ═══════════════════════════════
function renderSidebar(){
  const labels=t('navLabels');
  const reportCount = getReports().length;
  document.getElementById('sidebar-nav').innerHTML=labels.map((lbl,i)=>{
    let cls='nav-item';
    let num=i+1;
    let numStr=String(num);
    // Step 7 (Reports) is always accessible
    if(i===7){
      cls += i===S.step ? ' active' : '';
      numStr = '📊';
      const badge = reportCount > 0 ? `<span class="nav-badge">${reportCount}</span>` : '';
      return `<div class="${cls}" onclick="jumpTo(${i})" style="cursor:pointer">
        <div class="nav-circle">${numStr}</div>
        <div class="nav-label">${lbl}${badge}</div>
      </div>`;
    }
    if(i<S.step){cls+=' done';numStr='✓';}
    else if(i===S.step) cls+=' active';
    else cls+=' locked';
    return `<div class="${cls}" onclick="jumpTo(${i})">
      <div class="nav-circle">${numStr}</div>
      <div class="nav-label">${lbl}</div>
    </div>`;
  }).join('');
}
function jumpTo(i){ if(i===7 || i<=S.step){ S.step=i; renderStep(i); } }

// ═══════════════════════════════
//  RENDER STEP
// ═══════════════════════════════
function renderStep(n){
  document.querySelectorAll('.step').forEach((el,i)=>el.classList.toggle('on',i===n));
  renderSidebar();
  const sd=t('steps')[n];
  if(sd){
    const pill=document.getElementById(`s${n}-pill`);
    const title=document.getElementById(`s${n}-title`);
    const desc=document.getElementById(`s${n}-desc`);
    if(pill) pill.textContent=sd.pill;
    if(title) title.innerHTML=sd.title;
    if(desc) desc.textContent=sd.desc;
  }
  // update static labels
  ['spSel','spDepth','sumHeading','genBtn','genLoading','outDone','restart','copyAll','qGenTitle','qLoading','testTitle','testDesc','testNameLabel','testCallBtn','callAgentLabel','callTopbarRole','callPoweredBy'].forEach(k=>{
    const el=document.getElementById({
      spSel:'sp-sel-lbl',spDepth:'sp-depth-lbl',sumHeading:'sum-heading',
      genBtn:'btn-gen-txt',genLoading:'gen-loading-txt',outDone:'out-done-badge',
      restart:'restart-txt',copyAll:'copy-all-txt',qGenTitle:'qs-title-txt',
      qLoading:'q-loading-txt',
      testTitle:'test-title',testDesc:'test-desc',testNameLabel:'test-name-label',
      testCallBtn:'test-call-txt',callAgentLabel:'call-agent-label',
      callTopbarRole:'call-topbar-role',callPoweredBy:'call-powered',
    }[k]);
    if(el) el.textContent=t(k);
  });
  // update name input placeholder
  const nameInput=document.getElementById('test-candidate-name');
  if(nameInput) nameInput.placeholder=t('testNamePlaceholder');
  const renderers=[r0,r1,r2,r3,r4,r5,r6,renderReportsView];
  if(renderers[n]) renderers[n]();
  window.scrollTo({top:0,behavior:'smooth'});
}

// ─── STEP 0: Job Role ───
function r0(){
  const L=CUR.lang;
  document.getElementById('jobrole-grid').innerHTML=DATA.roles.map(r=>`
    <div class="card ${S.role===r.id?'sel':''}" onclick="pickRole('${r.id}')">
      <div class="card-ico">${r.ico||r.icon}</div>
      <div class="card-title">${r[L]||r.en}</div>
      <div class="card-desc">${L==='es'?r.dEs:r.dEn}</div>
    </div>`).join('');
  document.getElementById('btn-next-0').disabled=!S.role;
}
function pickRole(id){ S.role=id; S.skills=[]; S.questions=[]; S.selectedQs=[]; r0(); document.getElementById('btn-next-0').disabled=false; }

// ─── STEP 1: Skills ───
function r1(){
  const L=CUR.lang;
  const skills=DATA.skills[S.role]||[];
  const cnt=S.skills.length;
  document.getElementById('sp-count').textContent=cnt;
  document.getElementById('sp-sub-lbl').textContent=cnt===0?t('spSub'):(L==='es'?`${cnt} seleccionada${cnt!==1?'s':''}`:`${cnt} selected`);
  const tier=getTier(cnt);
  document.getElementById('tiers-display').innerHTML=DATA.tiers.map(tr=>{
    const isActive=cnt>0&&getTier(cnt)===tr;
    const range=tr.min>=6?'6+':tr.min===tr.max?`${tr.min}`:`${tr.min}–${tr.max}`;
    return `<div class="tier-row ${isActive?'active':''}">
      <div class="tier-badge">${range} skills</div>
      <div class="tier-detail"><b>${tr.dur}</b> · ${tr.maxQ}</div>
    </div>`;
  }).join('');
  document.getElementById('skills-grid').innerHTML=skills.map(sk=>`
    <div class="skill-chip ${S.skills.includes(sk.id)?'sel':''}" onclick="toggleSkill('${sk.id}')">
      <div class="skill-checkbox"><div class="skill-check-mark">✓</div></div>
      <div>
        <div class="sk-name">${sk[L]||sk.en}</div>
        <div class="sk-desc">${L==='es'?sk.dEs:sk.dEn}</div>
      </div>
    </div>`).join('');
  document.getElementById('btn-next-1').disabled=cnt<1;
}
function toggleSkill(id){
  S.skills=S.skills.includes(id)?S.skills.filter(s=>s!==id):[...S.skills,id];
  S.questions=[]; S.selectedQs=[];
  r1();
}

// ─── STEP 2: Q Style ───
function r2(){
  const L=CUR.lang;
  document.getElementById('qstyle-grid').innerHTML=DATA.qStyles.map(q=>`
    <div class="card ${S.qStyle===q.id?'sel':''}" onclick="pickQStyle('${q.id}')">
      <div class="card-ico">${q.icon}</div>
      <div class="card-title">${q[L]||q.en}</div>
      <div class="card-desc">${L==='es'?q.dEs:q.dEn}</div>
    </div>`).join('');
  document.getElementById('btn-next-2').disabled=!S.qStyle;
}
function pickQStyle(id){ S.qStyle=id; S.questions=[]; S.selectedQs=[]; r2(); document.getElementById('btn-next-2').disabled=false; }

// ─── STEP 3: Questions ───
async function r3(){
  const L=CUR.lang;
  const tier=getTier(S.skills.length);
  // Hint
  document.getElementById('numq-hint-box').innerHTML=
    L==='es'
    ?`Con <b>${S.skills.length} habilidades seleccionadas</b>, la entrevista durará aproximadamente <b>${tier.dur}</b>. Puedes seleccionar hasta <b>${tier.maxSel} preguntas</b>.`
    :`With <b>${S.skills.length} skills selected</b>, your interview will run approximately <b>${tier.dur}</b>. You can select up to <b>${tier.maxSel} questions</b>.`;

  updateQSelCount();

  // If we already have questions, just render them
  if(S.questions.length>0){ renderQList(); return; }

  // Otherwise fetch from API
  showQLoading(true);
  try {
    const role=DATA.roles.find(r=>r.id===S.role);
    const skills=DATA.skills[S.role].filter(sk=>S.skills.includes(sk.id));
    const qStyle=DATA.qStyles.find(q=>q.id===S.qStyle);
    const outputLang=L==='es'?'Spanish':'English';
    const skillsList=skills.map(s=>s.en).join(', ');

    const prompt=`You are an expert conversational AI interview designer for high-volume hiring.

Generate exactly 10 interview questions for the following configuration:
- Job Role: ${role?.en}
- Soft Skills to evaluate: ${skillsList}
- Question Style: ${qStyle?.en} (${qStyle?.dEn})
- Output language: ${outputLang}

Requirements:
- Each question must directly evaluate one of the listed soft skills
- Questions must be realistic, conversational, and specific to the job role (${role?.en})
- Questions should feel like something a professional ${qStyle?.en}-style recruiter would actually ask
- Avoid generic questions that could apply to any job
- Use natural, everyday language — not corporate jargon
- Distribute questions across different skills (don't repeat the same skill more than twice)

Respond ONLY with a valid JSON array. No markdown, no explanation, no extra text. Example format:
[
  {"q":"Your question text here?","skill":"Skill Name"},
  ...
]

Generate all 10 questions now:`;

    const res=await fetch("/api/generate",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        model:"gpt-5.2",
        max_completion_tokens:2048,
        messages:[{role:"user",content:prompt}]
      })
    });
    if(!res.ok){ const err=await res.json().catch(()=>({})); throw new Error(err.error||'API request failed'); }
    const data=await res.json();
    const raw=data.choices?.[0]?.message?.content||'[]';
    const clean=raw.replace(/```json|```/g,'').trim();
    const parsed=JSON.parse(clean);
    S.questions=Array.isArray(parsed)?parsed.slice(0,10):[];
    S.selectedQs=[];
  } catch(e){
    S.questions=[{q:"Could not load questions — please go back and try again.",skill:"Error"}];
  }
  showQLoading(false);
  renderQList();
}
function showQLoading(show){
  document.getElementById('q-loading-state').style.display=show?'flex':'none';
  document.getElementById('q-list').style.display=show?'none':'flex';
}
function renderQList(){
  const tier=getTier(S.skills.length);
  document.getElementById('q-list').innerHTML=S.questions.map((q,i)=>{
    const isSelected=S.selectedQs.includes(i);
    const atMax=S.selectedQs.length>=tier.maxSel&&!isSelected;
    return `<div class="q-item ${isSelected?'sel':''} ${atMax?'disabled':''}" onclick="toggleQ(${i})">
      <div class="q-num">${i+1}</div>
      <div style="flex:1">
        <div class="q-text">${escHtml(q.q||q.question||q.text||'')}</div>
        <div class="q-skill-tag">${escHtml(q.skill||'')}</div>
      </div>
    </div>`;
  }).join('');
  updateQSelCount();
  document.getElementById('btn-next-3').disabled=S.selectedQs.length<1;
}
function toggleQ(i){
  const tier=getTier(S.skills.length);
  if(S.selectedQs.includes(i)){
    S.selectedQs=S.selectedQs.filter(x=>x!==i);
  } else {
    if(S.selectedQs.length>=tier.maxSel) return;
    S.selectedQs=[...S.selectedQs,i].sort((a,b)=>a-b);
  }
  renderQList();
}
function updateQSelCount(){
  const tier=getTier(S.skills.length);
  const n=S.selectedQs.length;
  document.getElementById('q-sel-n').textContent=n;
  document.getElementById('qs-count-badge').textContent=t('qCountBadge',n);
  document.getElementById('q-sel-count-txt').innerHTML=`<b id="q-sel-n">${n}</b> ${t('qSelCount')}`;
  document.getElementById('q-max-txt').textContent=t('qMaxTxt',1,tier.maxSel);
  document.getElementById('btn-next-3').disabled=n<1;
}

// ─── STEP 4: Persona ───
function r4(){
  const L=CUR.lang;
  document.getElementById('persona-grid').innerHTML=DATA.personas.map(p=>`
    <div class="persona-card ${S.persona===p.id?'sel':''}" onclick="pickPersona('${p.id}')">
      <div class="persona-ava" style="background:${p.bg};color:${p.col}">${p.ico}</div>
      <div class="persona-name">${p[L]||p.en}</div>
      <div class="persona-tone" style="color:${p.col}">${L==='es'?p.tEs:p.tEn}</div>
      <div class="persona-traits">${L==='es'?p.trEs:p.trEn}</div>
    </div>`).join('');
  document.getElementById('btn-next-4').disabled=!S.persona;
}
function pickPersona(id){ S.persona=id; r4(); document.getElementById('btn-next-4').disabled=false; }

// ─── STEP 5: Summary ───
function r5(){
  const L=CUR.lang;
  const role=DATA.roles.find(r=>r.id===S.role);
  const skills=DATA.skills[S.role]?.filter(sk=>S.skills.includes(sk.id))||[];
  const qStyle=DATA.qStyles.find(q=>q.id===S.qStyle);
  const persona=DATA.personas.find(p=>p.id===S.persona);
  const tier=getTier(S.skills.length);
  const selQs=S.selectedQs.map(i=>S.questions[i]).filter(Boolean);
  document.getElementById('sum-tags').innerHTML=[
    role?`<span class="sum-tag">📋 ${role[L]||role.en}</span>`:'',
    ...skills.map(s=>`<span class="sum-tag teal">✓ ${s[L]||s.en}</span>`),
    qStyle?`<span class="sum-tag">❓ ${qStyle[L]||qStyle.en}</span>`:'',
    selQs.length?`<span class="sum-tag orange">🔢 ${selQs.length} questions</span>`:'',
    tier?`<span class="sum-tag">⏱ ${tier.dur}</span>`:'',
    persona?`<span class="sum-tag teal">🤖 ${persona[L]||persona.en}</span>`:'',
  ].join('');
}

// ─── STEP 6: Output ───
function r6(){ if(S.output) renderOutput(S.output); }

// ═══════════════════════════════
//  STEP 7: REPORTS
// ═══════════════════════════════
function renderReportsView(){
  const container = document.getElementById('reports-container');
  if(!container) return;
  if(currentReportView === 'detail' && currentReportId){
    const report = getReportById(currentReportId);
    if(report){ renderReportDetail(report, container); return; }
  }
  currentReportView = 'list';
  currentReportId = null;
  renderReportsList(container);
}

function renderReportsList(container){
  const reports = getReports();
  const L = CUR.lang;

  if(reports.length === 0){
    container.innerHTML = `
      <div class="reports-empty">
        <div class="reports-empty-icon">📊</div>
        <h2>${t('reportsTitle')}</h2>
        <p>${t('reportsEmpty')}</p>
      </div>`;
    return;
  }

  const rows = reports.map(r => {
    const roleName = typeof r.role === 'object' ? (r.role[L] || r.role.en || 'Interview') : (r.role || 'Interview');
    const dateStr = new Date(r.timestamp).toLocaleString(L === 'es' ? 'es-ES' : 'en-US', {
      month:'short', day:'numeric', year:'numeric', hour:'2-digit', minute:'2-digit'
    });
    let statusBadge = '';
    if(r.status === 'generating') statusBadge = `<span class="report-badge generating">${t('reportStatusGenerating')}</span>`;
    else if(r.status === 'done') statusBadge = `<span class="report-badge ready">${t('reportStatusReady')}</span>`;
    else if(r.status === 'error') statusBadge = `<span class="report-badge error">${t('reportStatusError')}</span>`;

    const score = r.data?.overall_score ? `<span class="report-score-mini">${r.data.overall_score}/5</span>` : '';

    const actions = r.status === 'error'
      ? `<button class="report-action-btn retry" onclick="event.stopPropagation();retryReportGeneration('${r.id}')" title="${t('reportRetry')}">↻</button>`
      : '';

    return `<tr class="reports-row ${r.status === 'done' ? 'clickable' : ''}" ${r.status === 'done' ? `onclick="viewReport('${r.id}')"` : ''}>
      <td class="reports-cell">${roleName}</td>
      <td class="reports-cell">${r.candidateName || '—'} ${score}</td>
      <td class="reports-cell">${dateStr}</td>
      <td class="reports-cell">${statusBadge}</td>
      <td class="reports-cell actions">
        ${actions}
        <button class="report-action-btn delete" onclick="event.stopPropagation();confirmDeleteReport('${r.id}')" title="Delete">✕</button>
      </td>
    </tr>`;
  }).join('');

  container.innerHTML = `
    <div class="reports-header">
      <h2>${t('reportsTitle')}</h2>
    </div>
    <div class="reports-table-wrap">
      <table class="reports-table">
        <thead>
          <tr>
            <th>${t('reportsColRole')}</th>
            <th>${t('reportsColCandidate')}</th>
            <th>${t('reportsColDate')}</th>
            <th>${t('reportsColStatus')}</th>
            <th>${t('reportsColActions')}</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    </div>`;
}

function viewReport(id){
  currentReportView = 'detail';
  currentReportId = id;
  renderReportsView();
  window.scrollTo({top:0,behavior:'smooth'});
}

function backToReportsList(){
  currentReportView = 'list';
  currentReportId = null;
  renderReportsView();
}

function confirmDeleteReport(id){
  if(confirm(t('reportDeleteConfirm'))){
    deleteReport(id);
    renderReportsView();
    renderSidebar();
  }
}

function retryReportGeneration(id){
  const report = getReportById(id);
  if(!report) return;
  report.status = 'generating';
  report.error = null;
  saveReport(report);
  renderReportsView();
  generateReportInBackground(report.conversationId, report.role, report.candidateName, report.skills, report.lang, S.sections);
}

function formatDuration(secs){
  if(!secs) return '—';
  const m = Math.floor(secs/60);
  const s = Math.floor(secs%60);
  return `${m}:${String(s).padStart(2,'0')}`;
}

function getScoreColor(score){
  if(score <= 2) return '#E57373';
  if(score === 3) return '#F0A830';
  return '#B8D4C8';
}

function getScoreLabel(score){
  const labels = {1:'Low Proficiency',2:'Below Average',3:'Average',4:'High Proficiency',5:'Exceptional'};
  return labels[score] || 'N/A';
}

function renderScoreRing(score, maxScore){
  const pct = (score / maxScore) * 100;
  const color = getScoreColor(score);
  const r = 54, c = 2 * Math.PI * r;
  const offset = c - (pct / 100) * c;
  return `<svg class="score-ring" viewBox="0 0 120 120" width="140" height="140">
    <circle cx="60" cy="60" r="${r}" fill="none" stroke="#E8E4DF" stroke-width="10"/>
    <circle cx="60" cy="60" r="${r}" fill="none" stroke="${color}" stroke-width="10"
      stroke-dasharray="${c}" stroke-dashoffset="${offset}"
      stroke-linecap="round" transform="rotate(-90 60 60)"
      style="transition:stroke-dashoffset 0.8s ease"/>
    <text x="60" y="54" text-anchor="middle" font-size="28" font-weight="700" fill="var(--text)">${score}</text>
    <text x="60" y="72" text-anchor="middle" font-size="12" fill="var(--muted)">/ ${maxScore}</text>
  </svg>`;
}

function renderBarChart(skillScores){
  if(!skillScores || !skillScores.length) return '<p style="color:var(--muted)">No skill data</p>';
  return skillScores.map(s => {
    const pct = (s.score / 5) * 100;
    const color = getScoreColor(s.score);
    return `<div class="bar-row">
      <div class="bar-label">${s.skill}</div>
      <div class="bar-track">
        <div class="bar-fill" style="width:${pct}%;background:${color}"></div>
      </div>
      <div class="bar-value">${s.score}/5</div>
    </div>`;
  }).join('');
}

function renderSentimentChart(trajectory){
  if(!trajectory || !trajectory.length) return '<p style="color:var(--muted)">No sentiment data</p>';
  const w = 400, h = 120, pad = 20;
  const n = trajectory.length;
  const xStep = (w - pad*2) / Math.max(n-1, 1);
  const yScale = (h - pad*2) / 4;
  const points = trajectory.map((v, i) => {
    const x = pad + i * xStep;
    const y = h - pad - (v - 1) * yScale;
    return `${x},${y}`;
  });
  const polyline = points.join(' ');
  const areaPoints = `${pad},${h-pad} ${polyline} ${pad + (n-1)*xStep},${h-pad}`;
  const avg = (trajectory.reduce((a,b)=>a+b,0)/n).toFixed(1);
  const avgColor = getScoreColor(Math.round(avg));

  return `<div class="sentiment-wrap">
    <svg class="sentiment-svg" viewBox="0 0 ${w} ${h}" preserveAspectRatio="none">
      <defs><linearGradient id="sentGrad" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0%" stop-color="${avgColor}" stop-opacity="0.3"/>
        <stop offset="100%" stop-color="${avgColor}" stop-opacity="0.02"/>
      </linearGradient></defs>
      <polygon points="${areaPoints}" fill="url(#sentGrad)"/>
      <polyline points="${polyline}" fill="none" stroke="${avgColor}" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
      ${trajectory.map((v,i)=>{
        const x=pad+i*xStep, y=h-pad-(v-1)*yScale;
        return `<circle cx="${x}" cy="${y}" r="4" fill="${avgColor}" stroke="white" stroke-width="1.5"/>`;
      }).join('')}
    </svg>
    <div class="sentiment-avg">
      <span class="sentiment-avg-num" style="color:${avgColor}">${avg}</span>
      <span class="sentiment-avg-lbl">/5 avg</span>
    </div>
  </div>`;
}

function renderReportDetail(report, container){
  const d = report.data;
  const L = report.lang || CUR.lang;
  const roleName = typeof report.role === 'object' ? (report.role[L] || report.role.en || '') : (report.role || '');
  const dateStr = new Date(report.timestamp).toLocaleString(L === 'es' ? 'es-ES' : 'en-US', {
    weekday:'long', month:'long', day:'numeric', year:'numeric', hour:'2-digit', minute:'2-digit'
  });

  // Candidate initials
  const parts = (report.candidateName || 'C').split(' ');
  const initials = parts.map(p=>p.charAt(0).toUpperCase()).slice(0,2).join('');

  // Recommendation badge
  const recMap = {Advance:{cls:'rec-advance',icon:'✓'},Hold:{cls:'rec-hold',icon:'⏸'},Reject:{cls:'rec-reject',icon:'✕'}};
  const rec = recMap[d?.recommendation] || recMap.Hold;
  const recLabel = d?.recommendation === 'Advance' ? t('reportAdvance') : d?.recommendation === 'Reject' ? t('reportReject') : t('reportHold');

  // Skill assessment cards
  const skillCards = (d?.skill_scores || []).map(s => `
    <div class="skill-card">
      <div class="skill-card-header">
        <span class="skill-card-name">${s.skill}</span>
        <span class="skill-card-score" style="background:${getScoreColor(s.score)}20;color:${getScoreColor(s.score)}">${s.score}/5</span>
      </div>
      <p class="skill-card-eval">${s.evaluation || ''}</p>
    </div>`).join('');

  // Strengths, concerns, red flags
  const listItems = (arr, cls) => (arr || []).map(item => `<div class="list-card ${cls}">${item}</div>`).join('');

  // Transcript
  const transcriptHtml = (report.transcript || []).map(msg => {
    const isAgent = msg.role === 'agent';
    return `<div class="transcript-msg ${isAgent ? 'agent' : 'user'}">
      <div class="transcript-speaker">${isAgent ? '🤖 Interviewer' : '👤 Candidate'}</div>
      <div class="transcript-text">${msg.message || ''}</div>
    </div>`;
  }).join('');

  container.innerHTML = `
    <div class="report-detail" id="report-detail-view">
      <!-- Action bar top -->
      <div class="report-action-bar">
        <button class="report-back-btn" onclick="backToReportsList()">← ${t('reportDetailBack')}</button>
        <button class="report-download-btn" onclick="printReport()">🖨 ${t('reportDetailDownload')}</button>
      </div>

      <!-- Header -->
      <div class="report-header">
        <div class="report-header-left">
          <h1 class="report-title">${t('reportDetailTitle')}</h1>
          <div class="report-date">${dateStr}</div>
        </div>
        <div class="report-header-right">
          <div class="report-rec-badge ${rec.cls}">${rec.icon} ${recLabel}</div>
        </div>
      </div>

      <!-- Candidate Profile -->
      <div class="report-section report-candidate">
        <div class="candidate-avatar">${initials}</div>
        <div class="candidate-info">
          <div class="candidate-name">${report.candidateName || 'Candidate'}</div>
          <div class="candidate-role">${roleName}</div>
          <div class="candidate-meta">${t('reportDetailDuration')}: ${formatDuration(report.callDuration)}</div>
        </div>
      </div>

      <!-- Overall Score + Skill Bar Chart -->
      <div class="report-section report-score-section">
        <div class="report-score-left">
          <h3>${t('reportDetailOverall')}</h3>
          ${renderScoreRing(d?.overall_score || 0, 5)}
          <div class="score-label" style="color:${getScoreColor(d?.overall_score||0)}">${d?.overall_label || getScoreLabel(d?.overall_score||0)}</div>
        </div>
        <div class="report-score-right">
          <h3>${t('reportDetailSkills')}</h3>
          <div class="bar-chart">${renderBarChart(d?.skill_scores)}</div>
        </div>
      </div>

      <!-- Assessment Summary -->
      <div class="report-section">
        <h3>${t('reportDetailSummary')}</h3>
        <div class="summary-card">${d?.assessment_summary || '—'}</div>
      </div>

      <!-- Skill Assessment Cards -->
      <div class="report-section">
        <h3>${t('reportDetailSkills')}</h3>
        <div class="skill-cards-grid">${skillCards || '<p style="color:var(--muted)">No skills data</p>'}</div>
      </div>

      <!-- Sentiment Analysis -->
      <div class="report-section">
        <h3>${t('reportDetailSentiment')}</h3>
        ${renderSentimentChart(d?.sentiment_trajectory)}
      </div>

      <!-- Strengths -->
      ${(d?.strengths?.length) ? `<div class="report-section">
        <h3>${t('reportDetailStrengths')}</h3>
        <div class="list-cards">${listItems(d.strengths, 'strength')}</div>
      </div>` : ''}

      <!-- Areas of Concern -->
      ${(d?.areas_of_concern?.length) ? `<div class="report-section">
        <h3>${t('reportDetailConcerns')}</h3>
        <div class="list-cards">${listItems(d.areas_of_concern, 'concern')}</div>
      </div>` : ''}

      <!-- Red Flags -->
      ${(d?.red_flags?.length) ? `<div class="report-section">
        <h3>${t('reportDetailRedFlags')}</h3>
        <div class="list-cards">${listItems(d.red_flags, 'flag')}</div>
      </div>` : ''}

      <!-- Candidate Feedback -->
      ${d?.candidate_feedback ? `<div class="report-section">
        <h3>${t('reportDetailFeedback')}</h3>
        <div class="feedback-card">"${d.candidate_feedback}"</div>
      </div>` : ''}

      <!-- Transcript -->
      <div class="report-section">
        <details class="transcript-accordion">
          <summary class="transcript-toggle">${t('reportDetailTranscript')} (${(report.transcript||[]).length} messages)</summary>
          <div class="transcript-body">${transcriptHtml || '<p style="color:var(--muted)">No transcript available</p>'}</div>
        </details>
      </div>

      <!-- Bottom action bar -->
      <div class="report-action-bar bottom">
        <button class="report-back-btn" onclick="backToReportsList()">← ${t('reportDetailBack')}</button>
        <button class="report-download-btn" onclick="printReport()">🖨 ${t('reportDetailDownload')}</button>
      </div>
    </div>`;
}

function printReport(){
  window.print();
}

// ═══════════════════════════════
//  NAVIGATION
// ═══════════════════════════════
function next(from){ S.step=from+1; renderStep(S.step); }
function prev(from){ S.step=from-1; renderStep(S.step); }

// ═══════════════════════════════
//  GENERATE
// ═══════════════════════════════
async function generateInterview(){
  const L=CUR.lang;
  const role=DATA.roles.find(r=>r.id===S.role);
  const skills=DATA.skills[S.role]?.filter(sk=>S.skills.includes(sk.id))||[];
  const qStyle=DATA.qStyles.find(q=>q.id===S.qStyle);
  const persona=DATA.personas.find(p=>p.id===S.persona);
  const tier=getTier(S.skills.length);
  const selQs=S.selectedQs.map(i=>S.questions[i]).filter(Boolean);
  const outputLang=L==='es'?'Spanish':'English';

  const skillsBlock=skills.map(s=>`- ${s.en}: ${L==='es'?s.dEs:s.dEn}`).join('\n');
  const qBlock=selQs.map((q,i)=>`Q${i+1}: ${q.q||q.question||q.text||''}\n   [Evaluates: ${q.skill}]`).join('\n');

  const genBtn=document.getElementById('btn-gen');
  const loading=document.getElementById('gen-loading');
  genBtn.style.display='none'; loading.classList.add('on');

  const prompt=`You are an expert conversational AI interview designer for high-volume hiring. You create complete, production-ready AI interview configurations modeled after professional enterprise voice/chat AI interview systems.

Generate the full system prompt for the AI recruiter. The output language is ${outputLang}.

CONFIGURATION:
- AI Persona Name: ${persona?.en}
- Tone: ${persona?.tEn}
- Personality: ${persona?.trEn}
- Job Role: ${role?.en}
- Soft Skills being evaluated:
${skillsBlock}
- Question Style: ${qStyle?.en}
- Interview Duration: ~${tier?.dur}
- Selected Interview Questions:
${qBlock}

CRITICAL: You MUST respond with a valid JSON object. No markdown, no code fences, no text outside the JSON.

The JSON object must have EXACTLY these 12 keys. Each value is a string containing the generated content for that section. Write all content in ${outputLang}.

{
  "role_and_tone": "1 paragraph defining who the AI is (name: ${persona?.en}, tone: ${persona?.tEn}), how it speaks, and how it treats candidates. Include: use the candidate's name, use natural human acknowledgments, mirror their energy, stay professional but warm. Do NOT use corporate jargon. Be specific about personality traits for ${persona?.en}.",

  "global_rules": "Clear numbered rules the AI MUST follow at all times. Include: 1) Never reveal internal scoring criteria, 2) Never skip questions, 3) Never make hiring promises, 4) Never go off-topic, 5) Redirect off-topic candidates, 6) Must ask all ${selQs.length} questions, 7) Don't improvise transitions, 8) Don't interrupt mid-answer. Add 2-3 more role-specific rules for ${role?.en}.",

  "pacing_and_listening": "A short paragraph (4–6 sentences) about how the AI should pace itself, listen actively, give candidates time, and respond to pauses without rushing or interrupting.",

  "acknowledgment_guidelines": "Specific guidance on how ${persona?.en} should acknowledge answers. Include: 4–5 phrases for positive/neutral answers (NOT 'amazing'), 3–4 phrases for concerns/negative info, rule about not repeating the same phrase, and matching acknowledgment to what was said.",

  "opening_script": "The exact opening script: 1) First line (warm, uses {{candidate_first_name}}, introduces as ${persona?.en}), 2) If YES to having time, 3) If NO/reschedule (with 3-reschedule limit warning), 4) If UNSURE/NERVOUS (empathetic response that moves forward).",

  "brief_role_reminder": "A concise (3–4 sentence) role overview for ${role?.en}. Keep factual and human, not a job ad. End with: 'Does that overall picture make sense?'",

  "candidate_questions_protocol": "Protocol for when candidate asks questions: answer briefly, use 'Great question. [Short answer.] Does that help?', unlimited questions allowed, never give specific hiring timelines, never promise employment.",

  "reschedule_leave_protocol": "Exact verbatim scripts for: 1) Candidate reschedules (acknowledge → confirm → 3-reschedule max warning → warm close), 2) Candidate no longer interested (acknowledge → warm close). Both must feel human and non-pressuring.",

  "question_flow": "For EACH of the ${selQs.length} questions, write: Q[N]: '[VERBATIM QUESTION TEXT]' / Skill evaluated / Good Path (1-2 sentences, ${persona?.tEn} tone) / Shallow Path (gentle follow-up, 2 sentences) / Uncertain Path (reassure + rephrase, 2 sentences) / Redirect Path (1 sentence). End with FOLLOW-UP LOGIC: if still can't answer, affirm + move on.",

  "closing_script": "Exact closing script after all ${selQs.length} questions: 1) Pre-close asking for candidate questions using {{candidate_first_name}}, 2) How to handle YES questions, 3) Final warm closing (no specific timelines), 4) Post-goodbye line.",

  "evaluation_schema": "For each skill: SKILL name, WHAT TO LISTEN FOR (3-4 behaviors), SCORING RUBRIC (1-5 with descriptions), RED FLAGS (1-2 patterns), PROBE QUESTION.",

  "post_interview_evaluation": "Complete evaluation prompt for after interview. Include: review each answer vs rubric, spot contradictions, ${role?.en}-specific red flags, structured output format with RECOMMENDATION, OVERALL SCORE, SKILL SCORES, STRENGTHS, AREAS OF CONCERN, RED FLAGS, SUGGESTED NEXT STEP."
}

IMPORTANT REMINDERS:
- Output ONLY the JSON object, nothing else
- All values must be strings (escape any quotes inside values)
- Write all content in ${outputLang}
- Be thorough, specific, and production-ready for each section
- For question_flow, include ALL ${selQs.length} questions with ALL paths`;

  try{
    const res=await fetch("/api/generate",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        model:"gpt-5.2",
        max_completion_tokens:8192,
        messages:[{role:"user",content:prompt}]
      })
    });
    if(!res.ok){ const err=await res.json().catch(()=>({})); throw new Error(err.error||'API request failed'); }
    const data=await res.json();
    let text=data.choices?.[0]?.message?.content||'';

    // Parse JSON response into sections
    let sections = null;
    try {
      // Strip markdown code fences if present
      text = text.replace(/^```(?:json)?\s*\n?/i, '').replace(/\n?```\s*$/i, '').trim();
      sections = JSON.parse(text);
    } catch (parseErr) {
      console.error('JSON parse failed, falling back to text:', parseErr);
      // If JSON fails, store raw text as output and don't populate sections
    }

    if (sections && typeof sections === 'object') {
      S.sections = sections;
      // Reassemble into text with section headers for display
      const SECTION_MAP = [
        { key: 'role_and_tone',              header: 'ROLE AND TONE' },
        { key: 'global_rules',               header: 'GLOBAL CRITICAL RULES' },
        { key: 'pacing_and_listening',        header: 'PACING AND LISTENING' },
        { key: 'acknowledgment_guidelines',   header: 'ACKNOWLEDGMENT GUIDELINES' },
        { key: 'opening_script',              header: 'OPENING' },
        { key: 'brief_role_reminder',         header: 'BRIEF ROLE REMINDER' },
        { key: 'candidate_questions_protocol',header: 'CANDIDATE QUESTIONS PROTOCOL' },
        { key: 'reschedule_leave_protocol',   header: 'IF CANDIDATE WANTS TO RESCHEDULE OR LEAVE' },
        { key: 'question_flow',              header: 'QUESTION FLOW' },
        { key: 'closing_script',              header: 'CLOSING' },
        { key: 'evaluation_schema',           header: 'EVALUATION SCHEMA' },
        { key: 'post_interview_evaluation',   header: 'POST-INTERVIEW EVALUATION PROMPT' },
      ];
      S.output = SECTION_MAP
        .filter(m => sections[m.key])
        .map(m => `=== ${m.header} ===\n${sections[m.key]}`)
        .join('\n\n');
    } else {
      S.output = text;
      S.sections = null;
    }

    S.step=6;
    renderStep(6);
  } catch(err){
    loading.classList.remove('on');
    genBtn.style.display='flex';
    alert('Generation failed. Please try again.');
  }
}

// ═══════════════════════════════
//  OUTPUT RENDER
// ═══════════════════════════════
const SECTIONS=[
  {key:'ROLE AND TONE',     icon:'🎭', label:{en:'Role & Tone',es:'Rol y Tono'},         tag:'type-blue'},
  {key:'GLOBAL CRITICAL RULES', icon:'⚠️', label:{en:'Global Critical Rules',es:'Reglas Críticas Globales'}, tag:'type-orange'},
  {key:'PACING AND LISTENING',  icon:'🎧', label:{en:'Pacing & Listening',es:'Ritmo y Escucha'},       tag:'type-blue'},
  {key:'ACKNOWLEDGMENT GUIDELINES', icon:'💬', label:{en:'Acknowledgment Guidelines',es:'Guía de Reconocimientos'}, tag:'type-blue'},
  {key:'OPENING',           icon:'👋', label:{en:'Opening Script',es:'Guión de Apertura'},         tag:'type-teal'},
  {key:'BRIEF ROLE REMINDER', icon:'📋', label:{en:'Brief Role Reminder',es:'Recordatorio del Rol'}, tag:'type-teal'},
  {key:'CANDIDATE QUESTIONS PROTOCOL', icon:'❓', label:{en:'Candidate Questions Protocol',es:'Protocolo de Preguntas'}, tag:'type-teal'},
  {key:'IF CANDIDATE WANTS TO RESCHEDULE OR LEAVE', icon:'🚪', label:{en:'Reschedule / Leave Protocol',es:'Protocolo de Reprogramación'}, tag:'type-orange'},
  {key:'QUESTION FLOW',     icon:'💭', label:{en:'Question Flow (All Paths)',es:'Flujo de Preguntas (Rutas)'},   tag:'type-teal'},
  {key:'CLOSING',           icon:'🤝', label:{en:'Closing Script',es:'Guión de Cierre'},           tag:'type-green'},
  {key:'EVALUATION SCHEMA', icon:'📊', label:{en:'Evaluation Schema',es:'Esquema de Evaluación'},      tag:'type-blue'},
  {key:'POST-INTERVIEW EVALUATION PROMPT', icon:'🎯', label:{en:'Post-Interview Eval Prompt',es:'Prompt de Evaluación'}, tag:'type-green'},
];

function renderOutput(text){
  const L=CUR.lang;
  const parsed={};
  SECTIONS.forEach((s,i)=>{
    const start=text.indexOf(`=== ${s.key} ===`);
    if(start===-1) return;
    const nextSec=SECTIONS.slice(i+1).find(ns=>text.indexOf(`=== ${ns.key} ===`)>start);
    const end=nextSec?text.indexOf(`=== ${nextSec.key} ===`):text.length;
    parsed[s.key]=text.slice(start+s.key.length+8,end).trim();
  });

  document.getElementById('out-blocks').innerHTML=SECTIONS.map((s,i)=>{
    const content=parsed[s.key]||'';
    if(!content) return '';
    const label=s.label[L]||s.label.en;
    return `<div class="out-block">
      <div class="out-block-head" onclick="toggleSec(${i})">
        <div class="out-block-title">${s.icon} ${label} <span class="type-tag ${s.tag}">${s.tag.replace('type-','')}</span></div>
        <div class="out-actions">
          <button class="cp-btn" onclick="event.stopPropagation();cpSection(this,'oc-${i}')">${t('copy')}</button>
          <button class="col-btn" id="col-${i}">−</button>
        </div>
      </div>
      <div class="out-content" id="oc-${i}">${escHtml(content)}</div>
    </div>`;
  }).filter(Boolean).join('');
}
function toggleSec(i){
  const c=document.getElementById(`oc-${i}`);
  const b=document.getElementById(`col-${i}`);
  if(c.classList.toggle('collapsed')) b.textContent='+';
  else b.textContent='−';
}
function cpSection(btn,id){
  const el=document.getElementById(id);
  if(!el) return;
  navigator.clipboard.writeText(el.textContent||'').then(()=>{
    btn.textContent=t('copied'); btn.classList.add('ok');
    setTimeout(()=>{ btn.textContent=t('copy'); btn.classList.remove('ok'); },2000);
  });
}
function copyAll(){
  const blocks=document.querySelectorAll('.out-content');
  const headers=document.querySelectorAll('.out-block-title');
  const text=Array.from(blocks).map((el,i)=>`=== ${(headers[i]?.textContent||'').trim()} ===\n${el.textContent}`).join('\n\n');
  navigator.clipboard.writeText(text).then(()=>{
    const btn=document.getElementById('copy-all-txt');
    const prev=btn.textContent;
    btn.textContent=t('copied');
    setTimeout(()=>btn.textContent=prev,2200);
  });
}
function escHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function restart(){
  if(testConversation) endTestInterview();
  Object.assign(S,{step:0,role:null,skills:[],qStyle:null,questions:[],selectedQs:[],persona:null,output:null,sections:null});
  const gl=document.getElementById('gen-loading');
  const gb=document.getElementById('btn-gen');
  if(gl) gl.classList.remove('on');
  if(gb) gb.style.display='flex';
  renderStep(0);
}

// ═══════════════════════════════
//  TEST INTERVIEW (ElevenLabs)
// ═══════════════════════════════
let testConversation = null;
let testTimerInterval = null;
let testStartTime = null;
let lastConversationId = null;
let currentReportView = 'list';
let currentReportId = null;

async function getSignedUrl() {
  const res = await fetch(`/api/elevenlabs-signed-url?lang=${CUR.lang}`);
  if (!res.ok) {
    const err = await res.json().catch(() => ({}));
    throw new Error(err.error || 'Failed to get signed URL');
  }
  const data = await res.json();
  return data.signedUrl;
}

async function startTestInterview() {
  const callBtn = document.getElementById('test-call-btn');
  const overlay = document.getElementById('call-overlay');
  const statusTxt = document.getElementById('call-status-txt');

  // Disable button while connecting
  callBtn.disabled = true;
  callBtn.style.opacity = '0.6';

  try {
    // Request microphone access
    await navigator.mediaDevices.getUserMedia({ audio: true });
  } catch (e) {
    callBtn.disabled = false;
    callBtn.style.opacity = '1';
    alert(t('testMicDenied'));
    return;
  }

  // Show overlay immediately in "connecting" state
  overlay.classList.remove('speaking', 'listening');
  overlay.classList.add('on', 'connecting');
  statusTxt.textContent = t('testConnecting');
  document.getElementById('call-agent-label').textContent = t('callAgentLabel');
  document.getElementById('call-topbar-role').textContent = t('callTopbarRole');
  document.getElementById('call-powered').textContent = t('callPoweredBy');
  document.getElementById('call-transcript').innerHTML = '';

  try {
    // Get signed URL from our proxy
    const signedUrl = await getSignedUrl();

    // Dynamically load the ElevenLabs SDK
    const { Conversation } = await import('https://esm.sh/@elevenlabs/client@latest');

    // Build dynamic variables from parsed sections, or fall back to full prompt override
    const candidateName = (document.getElementById('test-candidate-name')?.value || 'Test Candidate').trim();
    const sessionConfig = { signedUrl };
    if (S.sections) {
      const dynVars = {
        candidate_first_name:        candidateName,
        role_and_tone:               S.sections.role_and_tone || '',
        pacing_and_listening:        S.sections.pacing_and_listening || '',
        opening_script:              S.sections.opening_script || '',
        brief_role_reminder:         S.sections.brief_role_reminder || '',
        question_flow:               S.sections.question_flow || '',
        closing_script:              S.sections.closing_script || '',
        reschedule_leave_protocol:   S.sections.reschedule_leave_protocol || '',
        acknowledgment_guidelines:   S.sections.acknowledgment_guidelines || '',
        global_rules:                S.sections.global_rules || '',
        candidate_questions_protocol:S.sections.candidate_questions_protocol || '',
      };
      sessionConfig.dynamicVariables = dynVars;
    } else {
      sessionConfig.overrides = { agent: { prompt: { prompt: S.output } } };
    }

    // Start the conversation session with dynamic variables (or fallback override)
    testConversation = await Conversation.startSession({
      ...sessionConfig,
      onConnect: ({conversationId}) => {
        lastConversationId = conversationId;
        overlay.classList.remove('connecting');
        overlay.classList.add('listening');
        statusTxt.textContent = t('testListening');
        startTimer();
      },
      onDisconnect: () => {
        stopTimer();
        const convId = lastConversationId;
        testConversation = null;
        cleanupCall();
        if (convId && S.sections) {
          const cName = (document.getElementById('test-candidate-name')?.value || 'Test Candidate').trim();
          generateReportInBackground(convId, S.role || 'Interview', cName, S.skills || [], CUR.lang, S.sections);
        }
      },
      onError: () => {
        cleanupCall();
        alert(t('testError'));
      },
      onModeChange: ({ mode }) => {
        overlay.classList.remove('connecting', 'speaking', 'listening');
        if (mode === 'speaking') {
          overlay.classList.add('speaking');
          statusTxt.textContent = t('testSpeaking');
        } else {
          overlay.classList.add('listening');
          statusTxt.textContent = t('testListening');
        }
      },
      onMessage: (msg) => {
        const transcript = document.getElementById('call-transcript');
        if (!transcript) return;
        const isAgent = msg.source === 'ai';
        const text = msg.message || '';
        if (!text.trim()) return;
        // Find or create running bubble for this source
        const srcKey = isAgent ? 'agent' : 'user';
        const last = transcript.lastElementChild;
        if (last && last.dataset.src === srcKey) {
          last.textContent = (isAgent ? '🤖 ' : '🎤 ') + text;
        } else {
          const bubble = document.createElement('div');
          bubble.className = 'call-transcript-msg ' + srcKey;
          bubble.dataset.src = srcKey;
          bubble.textContent = (isAgent ? '🤖 ' : '🎤 ') + text;
          transcript.appendChild(bubble);
        }
        transcript.scrollTop = transcript.scrollHeight;
      }
    });
  } catch (err) {
    console.error('Test interview error:', err);
    cleanupCall();
    alert(t('testError'));
  }
}

async function endTestInterview() {
  const convId = lastConversationId;
  if (testConversation) {
    try { await testConversation.endSession(); } catch (e) { /* ignore */ }
    testConversation = null;
  }
  stopTimer();
  cleanupCall();
  if (convId && S.sections) {
    const cName = (document.getElementById('test-candidate-name')?.value || 'Test Candidate').trim();
    generateReportInBackground(convId, S.role || 'Interview', cName, S.skills || [], CUR.lang, S.sections);
  }
}

let micMuted = false;
function toggleMic() {
  if (!testConversation) return;
  micMuted = !micMuted;
  const micBtn = document.getElementById('call-mic-btn');
  const micIcon = document.getElementById('mic-icon');
  if (micMuted) {
    // Mute user microphone
    try { testConversation.setMicMuted(true); } catch(e) {}
    micBtn.classList.add('muted');
    micIcon.innerHTML = '<path d="M19 11h-1.7c0 .74-.16 1.43-.43 2.05l1.23 1.23c.56-.98.9-2.09.9-3.28zm-4.02.17c0-.06.02-.11.02-.17V5c0-1.66-1.34-3-3-3S9 3.34 9 5v.18l5.98 5.99zM4.27 3L3 4.27l6.01 6.01V11c0 1.66 1.33 3 2.99 3 .22 0 .44-.03.65-.08l1.66 1.66c-.71.33-1.5.52-2.31.52-2.76 0-5.3-2.1-5.3-5.1H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c.91-.13 1.77-.45 2.54-.9L19.73 21 21 19.73 4.27 3z"/>';
  } else {
    // Unmute user microphone
    try { testConversation.setMicMuted(false); } catch(e) {}
    micBtn.classList.remove('muted');
    micIcon.innerHTML = '<path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1-9c0-.55.45-1 1-1s1 .45 1 1v6c0 .55-.45 1-1 1s-1-.45-1-1V5zm6 6c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>';
  }
}

function cleanupCall() {
  stopTimer();
  testConversation = null;
  lastConversationId = null;
  const callBtn = document.getElementById('test-call-btn');
  const overlay = document.getElementById('call-overlay');
  if (callBtn) {
    callBtn.disabled = false;
    callBtn.style.opacity = '1';
  }
  if (overlay) overlay.classList.remove('on','connecting','speaking','listening');
  document.getElementById('call-timer').textContent = '00:00';
  const transcript = document.getElementById('call-transcript');
  if (transcript) transcript.innerHTML = '';
  // Reset mic state
  micMuted = false;
  const micBtn = document.getElementById('call-mic-btn');
  const micIcon = document.getElementById('mic-icon');
  if (micBtn) micBtn.classList.remove('muted');
  if (micIcon) micIcon.innerHTML = '<path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1-9c0-.55.45-1 1-1s1 .45 1 1v6c0 .55-.45 1-1 1s-1-.45-1-1V5zm6 6c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>';
}

function startTimer() {
  testStartTime = Date.now();
  testTimerInterval = setInterval(updateTimerDisplay, 1000);
}

function stopTimer() {
  if (testTimerInterval) {
    clearInterval(testTimerInterval);
    testTimerInterval = null;
  }
  testStartTime = null;
}

function updateTimerDisplay() {
  if (!testStartTime) return;
  const elapsed = Math.floor((Date.now() - testStartTime) / 1000);
  const m = String(Math.floor(elapsed / 60)).padStart(2, '0');
  const s = String(elapsed % 60).padStart(2, '0');
  document.getElementById('call-timer').textContent = `${m}:${s}`;
}

// ═══════════════════════════════
//  HELPERS
// ═══════════════════════════════

function formatCallTime(secs) {
  const totalSecs = Math.round(secs);
  const m = String(Math.floor(totalSecs / 60)).padStart(2, '0');
  const s = String(totalSecs % 60).padStart(2, '0');
  return `${m}:${s}`;
}

// ── TOAST NOTIFICATIONS ──

let toastTimeout = null;

function showReportToast(status, reportId) {
  const el = document.getElementById('report-toast');
  if (!el) return;
  clearTimeout(toastTimeout);

  let iconSvg = '';
  let msg = '';
  let actionHtml = '';
  let extraClass = '';

  if (status === 'generating') {
    iconSvg = '<svg class="report-toast-icon spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg>';
    msg = t('reportToastGenerating');
    extraClass = '';
    toastTimeout = setTimeout(() => hideReportToast(), 30000);
  } else if (status === 'ready') {
    iconSvg = '<svg class="report-toast-icon" viewBox="0 0 24 24" fill="none" stroke="var(--blue)" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>';
    msg = t('reportToastReady');
    extraClass = 'success';
    if (reportId) {
      actionHtml = `<button class="report-toast-action" onclick="viewReportFromToast('${reportId}')">${t('reportToastView')}</button>`;
    }
    toastTimeout = setTimeout(() => hideReportToast(), 8000);
  } else if (status === 'error') {
    iconSvg = '<svg class="report-toast-icon" viewBox="0 0 24 24" fill="none" stroke="#E57373" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M15 9l-6 6M9 9l6 6"/></svg>';
    msg = t('reportToastError');
    extraClass = 'error';
    toastTimeout = setTimeout(() => hideReportToast(), 6000);
  }

  el.className = 'report-toast ' + extraClass;
  el.innerHTML = iconSvg +
    '<span class="report-toast-msg">' + msg + '</span>' +
    actionHtml +
    '<button class="report-toast-close" onclick="hideReportToast()">&times;</button>';

  requestAnimationFrame(() => {
    el.classList.add('on');
  });
}

function hideReportToast() {
  clearTimeout(toastTimeout);
  const el = document.getElementById('report-toast');
  if (!el) return;
  el.classList.remove('on');
}

function viewReportFromToast(reportId) {
  hideReportToast();
  currentReportView = 'detail';
  currentReportId = reportId;
  S.step = 7;
  renderStep(7);
  updateNav();
}

// ── LOCALSTORAGE REPORT PERSISTENCE ──

const REPORTS_KEY = 'talkscore_interview_reports';

function getReports() {
  try {
    return JSON.parse(localStorage.getItem(REPORTS_KEY)) || [];
  } catch { return []; }
}

function saveReport(report) {
  try {
    const reports = getReports();
    const idx = reports.findIndex(r => r.id === report.id);
    if (idx >= 0) reports[idx] = report;
    else reports.unshift(report);
    localStorage.setItem(REPORTS_KEY, JSON.stringify(reports));
  } catch (e) {
    console.warn('Failed to save report:', e);
  }
}

function deleteReport(id) {
  const reports = getReports().filter(r => r.id !== id);
  localStorage.setItem(REPORTS_KEY, JSON.stringify(reports));
}

function getReportById(id) {
  return getReports().find(r => r.id === id) || null;
}

// ── BACKGROUND REPORT GENERATION ──

async function generateReportInBackground(conversationId, role, candidateName, skills, lang, sections) {
  console.log('[Report] Starting report generation for conversation:', conversationId);
  const reportId = 'rpt_' + Date.now();
  const report = {
    id: reportId,
    conversationId: conversationId,
    status: 'generating',
    role: typeof role === 'object' ? role : { en: role, es: role },
    candidateName: candidateName || 'Candidate',
    timestamp: Date.now(),
    lang: lang,
    callDuration: 0,
    skills: skills || [],
    data: null,
    transcript: [],
    error: null
  };
  saveReport(report);
  showReportToast('generating');

  try {
    // Step 1: Poll ElevenLabs for transcript with exponential backoff
    let transcript = [];
    let callDuration = 0;
    let attempts = 0;
    const maxAttempts = 40;
    let lastPollingError = null;

    while (attempts < maxAttempts) {
      attempts++;
      // Exponential backoff: 3s (1-10), 5s (11-25), 8s (26-40)
      const delay = attempts <= 10 ? 3000 : attempts <= 25 ? 5000 : 8000;
      await new Promise(r => setTimeout(r, delay));
      try {
        console.log(`[Report] Poll attempt ${attempts}/${maxAttempts} for conversation ${conversationId}`);
        const res = await fetch(`/api/elevenlabs-report?id=${conversationId}`);

        // Permanent errors — no point retrying
        if (res.status === 400 || res.status === 403 || res.status === 404) {
          const errData = await res.json().catch(() => ({}));
          throw new Error(`ElevenLabs API error ${res.status}: ${errData.error || 'Request rejected'}`);
        }

        if (!res.ok) {
          console.warn(`[Report] Poll attempt ${attempts} got status ${res.status}, retrying...`);
          lastPollingError = `HTTP ${res.status}`;
          continue;
        }
        const data = await res.json();
        console.log(`[Report] Poll attempt ${attempts} — ElevenLabs status: ${data.status}`);

        if (data.status === 'done' || data.status === 'completed') {
          transcript = data.transcript || [];
          callDuration = data.metadata?.call_duration_secs || 0;
          console.log(`[Report] Transcript received (${transcript.length} messages, ${callDuration}s call)`);
          break;
        }
        if (data.status === 'failed') {
          throw new Error('ElevenLabs conversation processing failed');
        }
      } catch (pollErr) {
        lastPollingError = pollErr.message;
        // Re-throw permanent errors immediately
        if (pollErr.message.includes('API error 4')) throw pollErr;
        if (attempts >= maxAttempts) throw pollErr;
        console.warn(`[Report] Poll attempt ${attempts} error: ${pollErr.message}`);
      }
    }

    if (transcript.length === 0) {
      throw new Error(lastPollingError
        ? `Transcript polling failed after ${maxAttempts} attempts: ${lastPollingError}`
        : `Transcript polling timed out after ${maxAttempts} attempts`);
    }

    report.transcript = transcript;
    report.callDuration = callDuration;
    saveReport(report);

    // Step 2: Call GPT for structured evaluation (with 120s timeout)
    console.log('[Report] GPT evaluation started');
    const evaluation = await Promise.race([
      generateGPTEvaluation(transcript, sections, skills, role),
      new Promise((_, reject) => setTimeout(() => reject(new Error('GPT evaluation timed out after 120s')), 120000))
    ]);
    console.log('[Report] GPT evaluation complete');

    report.data = evaluation;
    report.status = 'done';
    saveReport(report);
    console.log('[Report] Report saved with status: done');
    showReportToast('ready', reportId);

    // Refresh reports view if user is on step 7
    if (S.step === 7) renderStep(7);

  } catch (err) {
    report.status = 'error';
    report.error = err.message || 'Report generation failed';
    saveReport(report);
    showReportToast('error');
    console.error('[Report] Report generation failed:', err);

    // Refresh reports view so error status shows
    if (S.step === 7) renderStep(7);
  }
}

async function generateGPTEvaluation(transcript, sections, skills, role) {
  const roleName = typeof role === 'object' ? (role.en || role.es || 'Unknown Role') : (role || 'Unknown Role');
  const skillsList = (skills || []).join(', ');

  const transcriptText = transcript.map(msg => {
    const speaker = msg.role === 'agent' ? 'Interviewer' : 'Candidate';
    return `${speaker}: ${msg.message}`;
  }).join('\n');

  const evalSchema = sections?.evaluation_schema || '';
  const postInterviewEval = sections?.post_interview_evaluation || '';

  const systemPrompt = `You are an expert interview evaluator for Talkscore, an AI-powered recruitment assessment platform.
You analyze interview transcripts and provide structured evaluations with numerical scores (1-5 scale).
Always respond with valid JSON only, no markdown or extra text.`;

  const userPrompt = `Evaluate this interview transcript and provide a structured assessment.

**Role:** ${roleName}
**Skills Assessed:** ${skillsList}

**Evaluation Schema:**
${evalSchema}

**Post-Interview Evaluation Instructions:**
${postInterviewEval}

**Transcript:**
${transcriptText}

Respond with this exact JSON structure:
{
  "overall_score": <number 1-5>,
  "overall_label": "<text label: Low Proficiency / Below Average / Average / High Proficiency / Exceptional>",
  "recommendation": "<Advance | Hold | Reject>",
  "assessment_summary": "<2-3 paragraph assessment>",
  "skill_scores": [
    { "skill": "<skill name>", "score": <1-5>, "evaluation": "<2-3 sentence evaluation>" }
  ],
  "strengths": ["<strength 1>", "<strength 2>", "<strength 3>"],
  "areas_of_concern": ["<concern 1>", "<concern 2>"],
  "red_flags": ["<red flag if any, or empty array>"],
  "sentiment_trajectory": [<array of 1-5 scores per question>],
  "candidate_feedback": "<notable candidate quote or observation>"
}`;

  const controller = new AbortController();
  const fetchTimeout = setTimeout(() => controller.abort(), 90000);

  let res;
  try {
    res = await fetch('/api/generate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      signal: controller.signal,
      body: JSON.stringify({
        messages: [
          { role: 'system', content: systemPrompt },
          { role: 'user', content: userPrompt }
        ],
        max_completion_tokens: 4000,
        temperature: 0.3
      })
    });
  } catch (fetchErr) {
    clearTimeout(fetchTimeout);
    if (fetchErr.name === 'AbortError') {
      throw new Error('GPT evaluation fetch timed out after 90s');
    }
    throw new Error(`GPT evaluation network error: ${fetchErr.message}`);
  }
  clearTimeout(fetchTimeout);

  if (!res.ok) {
    const errBody = await res.text().catch(() => '');
    throw new Error(`GPT evaluation failed (HTTP ${res.status}): ${errBody.slice(0, 200)}`);
  }
  const result = await res.json();
  const content = result.choices?.[0]?.message?.content || '';

  // Parse JSON, stripping markdown code fences if present
  const cleaned = content.replace(/```json\s*/g, '').replace(/```\s*/g, '').trim();
  const evaluation = JSON.parse(cleaned);
  return evaluation;
}

// ═══════════════════════════════
//  INIT
// ═══════════════════════════════
refreshStaticText();
renderStep(0);
</script>
<div id="report-toast" class="report-toast"></div>
</body>
</html>
